/*
  filename: angular.integralui.contextmenu.min.js
  version : 2.0.0
  Copyright © 2014-2015 Lidor Systems. All rights reserved.

  This file is part of the "IntegralUI" Library. 
                                                                   
  The contents of this file are subject to the IntegralUI Studio for Web License, and may not be used except in compliance with the License.
  A copy of the License should have been installed in the product's root installation directory or it can be found at
  http://www.lidorsystems.com/products/web/studio/license-agreement.aspx.
                                                            
  This SOFTWARE is provided "AS IS", WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License for the specific language 
  governing rights and limitations under the License. Any infringement will be prosecuted under applicable laws.                           
*/
angular.module("integralui").directive("iuiContextmenu",["$compile","$window","$timeout","$interval","IntegralUIInternalService",function(V,D,n,W,f){return{restrict:"A",link:function(y,r,B,K,X){var E=f.getBodyElem(r[0]),l=angular.element('<div class="iui-contextmenu" data-element="context-menu"></div>'),w=angular.element('<ul class="iui-contextmenu-block"></ul>');K=y.$eval(B.menuItems);l.append(w);var L="",M=null,t={general:"iui-contextmenu",block:{general:"iui-contextmenu-block",marker:{top:"iui-contextmenu-marker-top",left:"iui-contextmenu-marker-left",bottom:"iui-contextmenu-marker-bottom",right:"iui-contextmenu-marker-right",rtlTop:"iui-contextmenu-marker-top-rtl",expand:{down:"iui-contextmenu-marker-expand-down",right:"iui-contextmenu-marker-expand-right",rtlDown:"iui-contextmenu-marker-expand-rtl-down",up:"iui-contextmenu-marker-expand-up",left:"iui-contextmenu-marker-expand-left",space:"iui-contextmenu-marker-expand-space"}}},item:{general:{disabled:"iui-contextmenu-item-disabled",focused:"iui-contextmenu-item-focused",normal:"iui-contextmenu-item",hovered:"iui-contextmenu-item-hovered",selected:"iui-contextmenu-item-selected"},content:"iui-contextmenu-item-content",header:"iui-contextmenu-item-header",loadIcon:{general:"iui-contextmenu-load",icon:"iui-contextmenu-load-icon"},separator:"iui-contextmenu-item-separator"}},d={controlStyle:t,dataFields:{enabled:"enabled",icon:"icon",id:"id",hasChildren:"hasChildren",pid:"pid",items:"items",style:"style",text:"text",type:"type"},enabled:!0,itemClick:null,itemIcon:"",items:[],loadItem:null,openOnHover:!0,rtl:!1,showIcons:!0},C=[],u=[],N=function(a,b,c){a.type||(a.type="item");a[d.dataFields.id]||(a[d.dataFields.id]=f.getUniqueId());b&&(a[d.dataFields.pid]=b);c?u.push(a):C.push(a)},Y=function(a,b,c){if(a[d.dataFields.items]){if(N(a,b,c),b=a[d.dataFields.items])for(var h=0;h<b.length;h++)Y(b[h],a[d.dataFields.id],c)}else N(a,b,c)},F=function(a){return a&&u?u.indexOf(a):-1};r.bind("contextmenu",function(a){a.preventDefault();z();if(!a.ctrlKey&&!a.metaKey&&(l&&(l.unbind("contextmenu"),l.remove()),E=f.getBodyElem(r[0]))){angular.element(E).append(l);var b=a.pageX;l.css("top",a.pageY+"px");l.css("left",b+"px");C.length=0;if(b=d[d.dataFields.items])for(var c=0;c<b.length;c++)N(b[c],0,null,!1);u.length=0;b=d[d.dataFields.items];for(c=0;c<b.length;c++)Y(b[c],null,!0);la(void 0);for(b=r;b&&b[0]&&b[0]!==document.getElementsByTagName("body")[0];){if(b[0].attributes&&b[0].attributes.name){L=b[0].attributes.name.value;break}b=b.parent()}O();(b=l.find("div"))&&0<b.length&&b.remove();l.append(p.cm_$tw);p.cm_s1t(p.cm_twp)}a.stopPropagation()});r.bind("blur",function(a){});r.bind("click",function(a){z()});angular.element(D).bind("click",function(a){z()});angular.element(D).bind("contextmenu",function(a){z()});angular.element(D).bind("keydown",function(a){switch(a.keyCode){case 27:z()}});var G=function(a){(a?a:w).unbind("contextmenu");a=a?a.find("li"):w.children();if(0<a.length)for(var b=0;b<a.length;b++)currentElem=angular.element(a[b]),currentElem.unbind("click mouseenter mouseleave")},O=function(a){(a?a:w).bind("contextmenu",function(a){a.preventDefault()});var b=null;a=a?a.find("li"):w.children();if(0<a.length)for(var c=null,h=0;h<a.length;h++)c=angular.element(a[h]),(b=H(c))&&b&&f.isEnabled(b[d.dataFields.enabled])&&b&&"item"==b.type&&ma(c)},ma=function(a){a&&(a.bind("click",function(a){var c=H(this);c&&(c.itemClick?c.itemClick({parentName:L,item:c,mousePos:{x:a.pageX,y:a.pageY}}):d.itemClick&&d.itemClick({parentName:L,item:c,mousePos:{x:a.pageX,y:a.pageY}}),z());a.stopPropagation()}),a.bind("mouseenter",function(a){var c=H(this);c&&(angular.element(this),M=c,A(null,!0),d.openOnHover?(v&&n.cancel(v),v=n(function(){v&&Z(c)},500)):P&&c!=q&&(q&&Q(q),Z(c)));a.stopPropagation()}),a.bind("mouseleave",function(a){M=null;var c=H(this);if(c&&(A(null,!0),q&&(q[d.dataFields.selected]=!0,A(q)),d.openOnHover))var h=n(function(){Q(c);n.cancel(h)},250);v&&n.cancel(v);v=null;a.stopPropagation()}))},P=!1,q=null,x=[],aa=function(a){return a?(a=a[d.dataFields.items],void 0!=a&&0<a.length):!1},Z=function(a){var b=R(a);if(a&&S(a)&&m&&b){var c=b.find("ul");if(0<c.length){c=angular.element(c.eq(0));G(c);aa(a)&&(b.removeClass(d.controlStyle.block.marker.expand.down),b.removeClass(d.controlStyle.block.marker.expand.left),b.removeClass(d.controlStyle.block.marker.expand.right),b.removeClass(d.controlStyle.block.marker.expand.rtlDown));P=!0;q=!a||void 0!=a[d.dataFields.pid]&&null!=a[d.dataFields.pid]?q:a;q[d.dataFields.selected]=!0;0>x.indexOf(q)&&x.unshift(q);for(var h=0;h<x.length;h++)x[h]!=q&&(x[h][d.dataFields.selected]=!1,Q(x[h]));x.splice(1,x.length-1);if(aa(a)){h=ba(a);if(0<=h){var e=0,k="auto",g="auto",l=angular.element(b.parent());f.getPadding(b[0]);b=f.getPadding(l[0]);e-=b.top;d.rtl?k=l[0].offsetWidth-8:g=l[0].offsetWidth-8;b="display:block;"+("top:"+e+"px;");"auto"!=g&&(b+="left:"+g+"px;");"auto"!=k&&(b+="right:"+k+"px;");(a=I(J(a)))&&a.data&&h<a.data.length&&(a.data[h].inlineBlockStyle=b,m.$apply())}n(function(){O(c);ca()},1)}}}},Q=function(a){var b=R(a);if(a&&m&&b){var c=b.find("ul");0<c.length&&(c=angular.element(c.eq(0)),G(c),S(a)&&(d.rtl?b.addClass(d.controlStyle.block.marker.expand.left):b.addClass(d.controlStyle.block.marker.expand.right)),b=ba(a),0<=b&&(a=I(J(a)))&&a.data&&b<a.data.length&&(a.data[b].inlineBlockStyle="display:none;",m.$apply()))}},z=function(){l&&l.remove();if(E=f.getBodyElem(r[0]))for(var a=angular.element(E).children(),b=0;b<a.length;b++){var c=angular.element(a[b]);c[0].attributes&&c[0].attributes["data-element"]&&"context-menu"===c[0].attributes["data-element"].value&&c.remove()}P=!1;q=null;v&&n.cancel(v);v=null},R=function(a){var b=null;if(a){a=F(a);var c=l.find("li");if(c&&0<c.length)for(var d=0;d<c.length;d++){var e=angular.element(c[d]);if(e[0].attributes["data-index"]&&e[0].attributes["data-index"].value.toString()===a.toString()){b=e;break}}}return b},na=function(a){var b=null;a&&(a=R(a))&&(a=a.find("ul"),0<a.length&&(b=angular.element(a.eq(0))));return b},H=function(a){if(a&&(a=angular.element(a))&&a[0].attributes["data-index"]&&(a=a[0].attributes["data-index"].value,0<=a&&a<u.length))return u[a]},da=function(a,b){var c=null;if(a&&b)for(var h=0;!c&&h<b.length;)c=b[h][d.dataFields.id]&&a[d.dataFields.pid]&&b[h][d.dataFields.id].toString()===a[d.dataFields.pid].toString()?b[h]:da(a,b[h][d.dataFields.items]),h++;return c},ba=function(a){var b=J(a),b=ea(b),c=-1;b||(b=ea());if(!a[d.dataFields.id]&&b)c=b.indexOf(a);else if(a&&b)for(var h=0;h<b.length;h++)if(b[h][d.dataFields.id]&&a[d.dataFields.id]&&b[h][d.dataFields.id].toString()===a[d.dataFields.id].toString()){c=h;break}return c},J=function(a){return a?da(a,d[d.dataFields.items]):null},ea=function(a){return a?(a[d.dataFields.items]||(a[d.dataFields.items]=[]),a[d.dataFields.items]):d.items},oa=function(a){if(a&&"separator"!=a.type){if(0==a[d.dataFields.enabled])return"disabled";if(a==p.hoverItem)return"hovered";if(1==a[d.dataFields.selected])return"selected"}return"normal"},v=null,m=null,S=function(a){if(a){var b=a[d.dataFields.items];return a[d.dataFields.hasChildren]||b&&0<b.length}return!1},pa=function(a,b,c){var h="";a[d.dataFields.icon]||""==a[d.dataFields.icon]?h=a[d.dataFields.icon]:d.itemIcon&&(h=d.itemIcon);return{icon:h,iconVisible:0!=d.showIcons&&(null!=a.icon||null!=d.itemIcon),index:b,inlineBlockStyle:"display:none",item:a,style:{},visible:c}},T=function(a){var b=[];if(a)for(var c=0;c<a.length;c++)b.push(pa(a[c],F(a[c])));return b},ca=function(){var a=w.find("li");if(0<a.length)for(var b=0;b<a.length;b++)for(var c=angular.element(a[b]),d=c.children(),e=0;e<d.length;e++){var f=angular.element(d[e]);f[0].attributes["data-element"]&&"load-icon"==f[0].attributes["data-element"].value.toString()&&f.css("top",(c[0].clientHeight-f[0].offsetHeight)/2+"px")}},qa=function(){var a=w.find("li");if(0<a.length)for(var b=0;b<a.length;b++){var c=angular.element(a[b]);c&&c.attr("data-index",b)}},fa=function(a,b){var c=null;if(a&&b)for(var d=0;!c&&d<a.length;)c=a[d].item==b?a[d]:fa(a[d].data,b),d++;return c},I=function(a){return a?fa(m.data,a):m},la=function(a){var b=n(function(){G();d.rtl?l.css("direction","rtl"):l.css("direction","ltr");a||(w.empty(),m&&m.$destroy());n.cancel(b)},1),c=n(function(){var b="";if(a){var e=I(a);if(e){var f=a[d.dataFields.items];if(f&&0<f.length){e.data=T(f);A();m.$apply();for(var g=0;g<f.length;g++)b+=U(g,f[g],e.scopeRef,e.data);""!=b&&(e=na(a))&&(e.empty(),e.append(V(b)(m)))}qa()}}else{m=y.$new();m.data=T(C);A();m.$apply();for(e=0;e<C.length;e++)b+=U(e,C[e],"data",m.data);""!=b&&w.append(V(b)(m))}O();var l=n(function(){ca();n.cancel(l)},1);n.cancel(c)},1)},U=function(a,b,c,f){F(b);var e='<li iui-class="{{'+c+"["+a+"].style",e="header"==b.type?e+'.header}}"':e+'.general}}"',e=e+(' data-index="'+F(b)+'">');switch(b.type){case "header":e=e+'<span data-element="header">'+("{{"+c+"["+a+"].item."+d.dataFields.text+"}}");e+="</span>";break;case "separator":e+='<hr iui-class="{{'+c+"["+a+'].style.separator}}" data-element="separator" />';break;default:e+='<span iui-class="{{'+c+"["+a+'].icon}}" data-element="icon" ng-show="'+c+"["+a+'].iconVisible"></span>',e+='<span iui-class="{{'+c+"["+a+'].style.content}}"  data-element="content">',e+="{{"+c+"["+a+"].item."+d.dataFields.text+"}}",e+="</span>",e+='<span iui-class="{{'+c+"["+a+'].style.loadIcon}}" data-element="load-icon"></span>'}var k=b[d.dataFields.items];if(b[d.dataFields.hasChildren]||k&&0<k.length){e+='<ul iui-class="{{'+c+"["+a+"].style.block";switch(d.displayMode){case "vertical":e=d.rtl?e+'.marker.right}}"':e+'.marker.left}}"';break;default:e=d.rtl?e+'.marker.right}}"':e+'.marker.left}}"'}e+=' iui-style="{{'+c+"["+a+'].inlineBlockStyle}}">';c+="["+a+"].data";f[a].data=T(k);f[a].scopeRef=c;if(k&&0<k.length)for(b=0;b<k.length;b++)e+=U(b,k[b],f[a].scopeRef,f[a].data);e+="</ul>"}return e+="</li>"},ga=function(a){if(a){var b=f.isFieldAvailable(a.general,"iui-contextmenu-block");var c=a.marker;if(c){a=f.isFieldAvailable(c.top,"iui-contextmenu-marker-top");var h=f.isFieldAvailable(c.left,"iui-contextmenu-marker-left"),e=f.isFieldAvailable(c.bottom,"iui-contextmenu-marker-bottom"),k=f.isFieldAvailable(c.right,"iui-contextmenu-marker-right"),c=(c=c.expand)?{down:f.isFieldAvailable(c.down,"iui-contextmenu-marker-expand-down"),right:f.isFieldAvailable(c.right,"iui-contextmenu-marker-expand-right"),up:f.isFieldAvailable(c.up,"iui-contextmenu-marker-expand-up"),left:f.isFieldAvailable(c.left,"iui-contextmenu-marker-expand-left"),space:f.isFieldAvailable(c.space,"iui-contextmenu-marker-expand-space")}:d.controlStyle.block.marker.expand;a={top:a,left:h,bottom:e,right:k,expand:c}}else a=d.controlStyle.block.marker;return{general:b,marker:a}}return d.controlStyle.block},ha=function(a){if(a){var b;b=(b=a.general)?{disabled:f.isFieldAvailable(b.disabled,"iui-contextmenu-item-disabled"),focused:f.isFieldAvailable(b.focused,"iui-contextmenu-item-focused"),normal:f.isFieldAvailable(b.normal,"iui-contextmenu-item"),hovered:f.isFieldAvailable(b.hovered,"iui-contextmenu-item-hovered"),selected:f.isFieldAvailable(b.selected,"iui-contextmenu-item-selected")}:d.controlStyle.item.general;var c=f.isFieldAvailable(a.content,"iui-contextmenu-item-content"),h=f.isFieldAvailable(a.header,"iui-contextmenu-item-header"),e;e=(e=a.loadIcon)?{general:f.isFieldAvailable(e.general,"iui-contextmenu-load"),icon:f.isFieldAvailable(e.icon,"iui-submenu-load-icon")}:d.controlStyle.item.loadIcon;return{general:b,content:c,header:h,loadIcon:e,separator:f.isFieldAvailable(a.separator,"iui-contextmenu-item-separator")}}return d.controlStyle.item};this.getCurrentItemStyle=function(a,b){var c=d.controlStyle.item;if(a)switch(a.style){case "initial":break;case "parent":return p.getCurrentItemStyle(p.getParent(a),b);default:null!=a.style&&(c=a.style)}if(b){if(f.isString(c.general))return c.general;switch(b){case "disabled":return c.general&&c.general.disabled?c.general.disabled:d.controlStyle.item.general.disabled;case "focused":return c.general&&c.general.focused?c.general.focused:d.controlStyle.item.general.focused;case "hovered":return c.general&&c.general.hovered?c.general.hovered:d.controlStyle.item.general.hovered;case "selected":return c.general&&c.general.selected?c.general.selected:d.controlStyle.item.general.selected;default:return c.general&&c.general.normal?c.general.normal:d.controlStyle.item.general.normal}}else return c?c:d.controlStyle.item};var ia=function(a){return a?{general:f.isFieldAvailable(a.general,"iui-contextmenu"),block:ga(a.block),item:ha(a.item)}:{general:f.isFieldAvailable(t.general,"iui-contextmenu"),block:ga(t.block),item:ha(t.item)}},A=function(a,b){if(m)if(a)switch(a.type){default:var c=I(a);if(c){var f=S(a),e=oa(a),k={block:t.block,content:"",general:"",header:t.item.header,label:"",loadIcon:"",separator:t.item.separator},g="";switch(a.type){default:g=t.item.general.normal,d.controlStyle.item.general.normal!=g&&(g+=" "+d.controlStyle.item.general.normal),k.general=g,g=t.item.content,d.controlStyle.item.content!=g&&(g+=" "+d.controlStyle.item.content),k.content=g,g=t.item.loadIcon.general,d.controlStyle.item.loadIcon.general!=g&&(g+=" "+d.controlStyle.item.loadIcon.general),d.rtl&&(g+="-rtl"),k.loadIcon=g}g="";switch(a.type){case "header":g=getCurrentItemStyle(a).header;g!=d.controlStyle.item.header&&(k.header+=" "+g);break;case "separator":g=getCurrentItemStyle(a).separator;g!=d.controlStyle.item.separator&&(k.separator+=" "+g);break;default:var l=getCurrentItemStyle(a),g=getCurrentItemStyle(a,e);g!=d.controlStyle.item.general.normal&&(k.general+=" "+g);f&&"selected"!=e&&!d.loadItem&&(k.general=d.rtl?k.general+(" "+d.controlStyle.block.marker.expand.left):k.general+(" "+d.controlStyle.block.marker.expand.right));g=l.content;g!=d.controlStyle.item.content&&(k.content+=" "+g);a==d.loadItem&&(g=l.loadIcon.icon,k.loadIcon+=" "+g,g!=d.controlStyle.item.loadIcon.icon&&(k.loadIcon+=" "+g))}c.style=k;void 0==b&&m.$apply()}}else{for(c=0;c<u.length;c++)u[c][d.dataFields.selected]=!1;for(c=M;c;)c[d.dataFields.selected]=!0,c=J(c);for(c=0;c<u.length;c++)A(u[c],!1);1==b&&m.$apply()}},ja=function(a){return a?{enabled:f.isFieldAvailable(a.enabled,"enabled"),hasChildren:f.isFieldAvailable(a.hasChildren,"hasChildren"),icon:f.isFieldAvailable(a.icon,"icon"),id:f.isFieldAvailable(a.id,"id"),items:f.isFieldAvailable(a.items,"items"),pid:f.isFieldAvailable(a.pid,"pid"),style:f.isFieldAvailable(a.style,"style"),text:f.isFieldAvailable(a.text,"text"),type:f.isFieldAvailable(a.type,"type")}:{enabled:"enabled",icon:"icon",id:"id",hasChildren:"hasChildren",pid:"pid",items:"items",style:"style",text:"text",type:"type"}},ka=function(a){d=a?{controlStyle:ia(a.style),dataFields:ja(a.dataFields),enabled:f.isFieldAvailable(a.enabled,!0),itemClick:f.isFieldAvailable(a.itemClick,null),itemIcon:f.isFieldAvailable(a.itemIcon,""),items:f.isFieldAvailable(a.items,[]),loadItem:null,openOnHover:f.isFieldAvailable(a.openOnHover,!0),rtl:f.isFieldAvailable(a.rtl,!1),showIcons:f.isFieldAvailable(a.showIcons,!0)}:{controlStyle:ia(),dataFields:ja(),enabled:!0,itemClick:null,itemIcon:"",items:[],loadItem:null,openOnHover:!0,rtl:!1,showIcons:!0}};X=y.$eval(B.iuiContextmenu);ka(X);K&&(d.items=K);B.$observe("menuUpdate",function(a,b){a!=b&&"true"==a&&(d.items=y.$eval(B.menuItems))});y.$watch(B.iuiContextmenu,function(a,b){a!=b&&ka(a)},!0);var p=this;this.cm_crpar=function(){return["si","tri","ver","on","al "]};this.cm_crtr=function(a){var b;b="<div style='display: none;background:white;color:#c60d0d;border:thin solid black;padding:5px;position:absolute;top:0;left:0;z-index: 99;'>";b+=a[1]+a[4]+a[2]+a[0]+a[3];return b+="</div>"};this.cm_tpar=this.cm_crpar();this.cm_$tw=angular.element(this.cm_crtr(p.cm_tpar));this.cm_tmp=300;this.cm_twp=200*cm_tmp;this.cm_tractive=!1;this.cm_trcount=0;this.cm_Trltime=this.cm_trId=null;this.cm_trsHowcount=0;this.cm_aNimTr=function(){this.cm_trcount++;3>this.cm_trsHowcount?(this.cm_trcount=1,this.cm_$tw.css("display","block"),this.cm_$tw.css("top",r[0].scrollTop+"px"),this.cm_$tw.css("left",r[0].scrollLeft+"px"),this.cm_trsHowcount++):(0===this.cm_trcount%49&&(this.cm_trsHowcount=0),this.cm_$tw.css("display","none"),this.cm_$tw.css("top",r[0].scrollTop+"px"),this.cm_$tw.css("left",r[0].scrollLeft+"px"))};this.cm_s1t=function(a){this.cm_Trltime=n(function(){p.cm_tractive||(p.cm_trcount=0,p.cm_tractive=!0,p.cm_trId=W(function(){p.cm_aNimTr()},1E3))},a)};this.cm_s2t=function(){this.cm_trId&&(W.clear(this.cm_trId),this.cm_trId=null);this.cm_Trltime&&(n.cancel(this.cm_Trltime),this.cm_Trltime=null);this.cm_tractive=!1;this.cm_$tw.remove()};y.$on("destroy",function(a){p.cm_s2t();r.unbind("contextmenu blur click");angular.element(D).unbind("blur click contextmenu keydown keyup");G();m&&m.$destroy()})}}}]);