/*
  filename: angular.integralui.treeview.min.js
  version : 2.2.0
  Copyright © 2014-2015 Lidor Systems. All rights reserved.

  This file is part of the "IntegralUI" Library. 
                                                                   
  The contents of this file are subject to the IntegralUI Studio for Web License, and may not be used except in compliance with the License.
  A copy of the License should have been installed in the product's root installation directory or it can be found at
  http://www.lidorsystems.com/products/web/studio/license-agreement.aspx.
                                                            
  This SOFTWARE is provided "AS IS", WITHOUT WARRANTY OF ANY KIND, either express or implied. See the License for the specific language 
  governing rights and limitations under the License. Any infringement will be prosecuted under applicable laws.                           
*/
angular.module("integralui").factory("IntegralUITreeViewService",["$rootScope",function(c){var l=null;return{addItem:function(e,k,f){c.$broadcast(e+"-add-item",k,f)},clearItems:function(e,k){c.$broadcast(e+"-clear-items",k)},insertItemAt:function(e,k,f,l){c.$broadcast(e+"-insert-item-at",k,f,l)},insertItemBefore:function(e,k,f){c.$broadcast(e+"-insert-item-before",k,f)},insertItemAfter:function(e,k,f){c.$broadcast(e+"-insert-item-after",k,f)},removeItem:function(e,k){c.$broadcast(e+"-remove-item",k)},removeItemAt:function(e,k,f){c.$broadcast(e+"-remove-item-at",k,f)},exportToJSON:function(e,k,f,l){c.$broadcast(e+"-export-json",k,f,l);e=this.getTempData();this.clearTempData();return e?e:""},loadData:function(e,k,f,l,g){c.$broadcast(e+"-load-data",k,f,l,g)},openEditor:function(e,k){c.$broadcast(e+"-open-editor",k)},closeEditor:function(e,k){c.$broadcast(e+"-close-editor",k)},beginLoad:function(e,k){c.$broadcast(e+"-begin-load",k)},collapse:function(e,k){c.$broadcast(e+"-collapse",k)},endLoad:function(e){c.$broadcast(e+"-end-load")},expand:function(e,k){c.$broadcast(e+"-expand",k)},toggle:function(e,k){c.$broadcast(e+"-toggle",k)},findItemById:function(e,k){c.$broadcast(e+"-find-item-by-id",k);var f=this.getTempData();this.clearTempData();return f?f:null},findItemByText:function(e,k){c.$broadcast(e+"-find-item-by-text",k);var f=this.getTempData();this.clearTempData();return f?f:null},getItemParent:function(e,k){c.$broadcast(e+"-get-item-parent",k);var f=this.getTempData();this.clearTempData();return f?f:null},filter:function(e,k){c.$broadcast(e+"-filter",k)},focus:function(e,k){c.$broadcast(e+"-focus",k)},clearTempData:function(){l=null},ensureVisible:function(e,k,f){c.$broadcast(e+"-ensure-visible",k,f)},getCheckList:function(e,k){c.$broadcast(e+"-get-check-list",k);var f=this.getTempData();this.clearTempData();return f?f:[]},getItemLevel:function(e,k){c.$broadcast(e+"-get-item-level",k);var f=this.getTempData();this.clearTempData();return f?f:0},getFlatList:function(e,k){c.$broadcast(e+"-get-flat-list",k);var f=this.getTempData();this.clearTempData();return f?f:[]},getFullPath:function(e,k){c.$broadcast(e+"-get-full-path",k);var f=this.getTempData();this.clearTempData();return f?f:""},getList:function(e,k,f){c.$broadcast(e+"-get-list",k,f);e=this.getTempData();this.clearTempData();return e?e:[]},getTempData:function(){return l},setTempData:function(c){l=c},clearSelection:function(e){c.$broadcast(e+"-clear-selection")},selectedItem:function(e,k){if(k)c.$broadcast(e+"-set-selected-item",k);else{c.$broadcast(e+"-get-selected-item");var f=this.getTempData();this.clearTempData();return f?f:null}},selectedItems:function(e){c.$broadcast(e+"-get-selected-items");e=this.getTempData();this.clearTempData();return e?e:null},getScrollPos:function(e){c.$broadcast(e+"-get-scroll-pos");e=this.getTempData();this.clearTempData();return e?e:{x:0,y:0}},setScrollPos:function(e,k){c.$broadcast(e+"-set-scroll-pos",k)},scrollTo:function(e,k,f){c.$broadcast(e+"-scroll-to",k,f)},sort:function(e,k,f){c.$broadcast(e+"-sort",k,f)},updateCheckValues:function(e,k){c.$broadcast(e+"-update-check",k)},refresh:function(e,k,f){c.$broadcast(e+"-refresh",k,f)},resumeLayout:function(e){c.$broadcast(e+"-resume-layout")},suspendLayout:function(e){c.$broadcast(e+"-suspend-layout")},updateLayout:function(e){c.$broadcast(e+"-update-layout")},updateView:function(e){c.$broadcast(e+"-update-view")}}}]).controller("IntegralUITreeViewController",["$scope","$element","$timeout","$window","IntegralUIInternalService","IntegralUIDataService","IntegralUITreeViewService","IntegralUIDragDrop","IntegralUIFilter",function(c,l,e,k,f,D,g,m,ea){var a=this;a.hoverItem=null;this.suppressProcess=!1;a.defaultCheckBoxStyle={general:"iui-checkbox",box:{general:"iui-checkbox-box",disabled:"iui-checkbox-box-disabled",checked:"iui-checkbox-checked",indeterminate:"iui-checkbox-indeterminate",unchecked:"iui-checkbox-unchecked"}};a.defaultStyle={general:"iui-treeview",item:{general:{disabled:"iui-treeview-item-disabled",focused:"iui-treeview-item-focused",normal:"iui-treeview-item",hovered:"iui-treeview-item-hovered",selected:"iui-treeview-item-selected"},checkBox:{general:"iui-checkbox",box:{general:"iui-checkbox-box",disabled:"iui-checkbox-box-disabled",checked:"iui-checkbox-checked",indeterminate:"iui-checkbox-indeterminate",unchecked:"iui-checkbox-unchecked"}},expandBox:{general:"iui-treeview-expand-box",animated:"iui-treeview-expand-box-load",expanded:"iui-treeview-expand-box-open",collapsed:"iui-treeview-expand-box-close"},content:{disabled:"iui-treeview-item-content-disabled",focused:"iui-treeview-item-content-focused",normal:"iui-treeview-item-content",hovered:"iui-treeview-item-content-hovered",selected:"iui-treeview-item-content-selected"}}};a.defaultCheckBoxSettings={autoCheck:!1,style:a.defaultCheckBoxStyle,threeState:!1};this.updateOptions=function(b){b?(a.options={allowAnimation:f.isFieldAvailable(b.allowAnimation,!0),allowDrag:f.isFieldAvailable(b.allowDrag,!1),allowDrop:f.isFieldAvailable(b.allowDrop,!0),allowFocus:f.isFieldAvailable(b.allowFocus,!0),animationSpeed:200,autoCheck:f.isFieldAvailable(b.autoCheck,!1),autoExpand:f.isFieldAvailable(b.autoExpand,!0),checkBoxSettings:a.defaultCheckBoxSettings,controlStyle:a.defaultStyle,editorSettings:{activate:"click"},hoverSelection:f.isFieldAvailable(b.hoverSelection,!1),indent:f.isFieldAvailable(b.indent,15),itemIcon:f.isFieldAvailable(b.itemIcon,""),itemSpacing:f.isFieldAvailable(b.itemSpacing,1),labelEdit:f.isFieldAvailable(b.labelEdit,!1),loadItem:null,pathSeparator:f.isFieldAvailable(b.pathSeparator,"\\"),rtl:f.isFieldAvailable(b.rtl,!1),selectedIndex:-1,selectedItem:f.isFieldAvailable(b.selectedItem,a.options.selectedItem?a.options.selectedItem:null),selectedItems:[],selectionMode:f.isFieldAvailable(b.selectionMode,"one"),showCheckBoxes:f.isFieldAvailable(b.showCheckBoxes,!1),showIcons:f.isFieldAvailable(b.showIcons,!0),showStatusIcons:f.isFieldAvailable(b.showStatusIcons,!1),sorting:f.isFieldAvailable(b.sorting,"none")},a.updateDataFields(b.dataFields),a.updateControlStyle(b.controlStyle),a.updateCheckBoxSettings(b.checkBoxSettings)):(a.options={allowAnimation:!0,allowDrag:!1,allowDrop:!0,allowFocus:!0,animationSpeed:200,autoCheck:!1,autoExpand:!0,checkBoxSettings:a.defaultCheckBoxSettings,controlStyle:a.defaultStyle,editorSettings:{activate:"click"},hoverSelection:!1,indent:15,itemIcon:"",itemSpacing:1,labelEdit:!1,loadItem:null,pathSeparator:"\\",rtl:!1,selectedIndex:-1,selectedItem:null,selectedItems:[],selectionMode:"one",showCheckBoxes:!1,showIcons:!0,showStatusIcons:!1,sorting:"none"},a.updateDataFields())};a.options={};this.updateDataFields=function(b){a.options.dataFields=b?{allowDrag:b.allowDrag?b.allowDrag:"allowDrag",allowDrop:b.allowDrop?b.allowDrop:"allowDrop",allowEdit:b.allowEdit?b.allowEdit:"allowEdit",allowFocus:b.allowFocus?b.allowFocus:"allowFocus",autoCheck:b.autoCheck?b.autoCheck:"autoCheck",checkBoxSettings:b.checkBoxSettings?b.checkBoxSettings:"checkBoxSettings",checked:b.checked?b.checked:"checked",checkState:b.checkState?b.checkState:"checkState",content:b.content?b.content:"content",enabled:b.enabled?b.enabled:"enabled",expanded:b.expanded?b.expanded:"expanded",hasChildren:b.hasChildren?b.hasChildren:"hasChildren",icon:b.icon?b.icon:"icon",id:b.id?b.id:"id",items:b.items?b.items:"items",pid:b.pid?b.pid:"pid",statusIcon:b.statusIcon?b.statusIcon:"statusIcon",style:b.style?b.style:"style",text:b.text?b.text:"text",value:b.value?b.value:"value"}:{allowDrag:"allowDrag",allowDrop:"allowDrop",allowEdit:"allowEdit",allowFocus:"allowFocus",autoCheck:"autoCheck",checkBoxSettings:"checkBoxSettings",checked:"checked",checkState:"checkState",content:"content",enabled:"enabled",expanded:"expanded",hasChildren:"hasChildren",icon:"icon",id:"id",items:"items",pid:"pid",statusIcon:"statusIcon",style:"style",text:"text",value:"value"};a.dataObj&&a.dataObj.updateDataFields(a.options.dataFields)};a.updateOptions();c.$on(c.name+"-add-item",function(b,d,c){a.dataObj.insertAt(d,-1,c,a.itemIsAdded)});c.$on(c.name+"-clear-items",function(b,d){a.dataObj.clear(d,a.listIsCleared)});c.$on(c.name+"-insert-item-at",function(b,d,c,h){a.dataObj.insertAt(d,c,h,a.itemIsAdded)});c.$on(c.name+"-insert-item-after",function(b,d,c){a.dataObj.insertByRef(d,c,!0,a.itemIsAdded)});c.$on(c.name+"-insert-item-before",function(b,d,c){a.dataObj.insertByRef(d,c,!1,a.itemIsAdded)});c.$on(c.name+"-remove-item",function(b,d){a.dataObj.removeAt(d,-1,null,a.itemIsRemoved)});c.$on(c.name+"-remove-item-at",function(b,d,c){a.dataObj.removeAt(null,d,c,a.itemIsRemoved)});this.listIsCleared=function(b){b||(a.clearPrevSelection(),a.options.selectedItem=null,a.setScrollPos({x:0,y:0}));a.updateLayout()};this.itemIsAdded=function(){a.updateLayout()};this.itemIsRemoved=function(b,d,c,h){b&&(b.selected=!1,b==a.options.selectedItem&&(a.options.selectedItem=null));a.updateLayout()};this.objIsRemoved=function(b,d,c){a.updateLayout()};this.getCheckValue=function(b){return"checked"==b[a.options.dataFields.checkState]?"checked":1==a.options.checkBoxSettings.threeState&&"indeterminate"==b[a.options.dataFields.checkState]?"indeterminate":"unchecked"};this.changeCheckValue=function(b){if(1==a.options.autoCheck||1==a.options.checkBoxSettings.autoCheck){var d=a.getCheckValue(b),n=!1,n=1==a.options.checkBoxSettings.threeState?a.callCheckValueChanging(b,d):a.callCheckValueChanging(b,"checked"==d?!0:!1);if(!1!==n){if(1==a.options.checkBoxSettings.threeState)switch(d){case "checked":d="unchecked";break;case "indeterminate":d="checked";break;case "unchecked":d="indeterminate"}else d="unchecked"==d||"indeterminate"==d?"checked":"unchecked";b[a.options.dataFields.checkState]=d;b[a.options.dataFields.checked]="checked"==d?!0:!1;c.$apply()}}};this.callCheckValueChanging=function(b,d){var n=!0;a.allowEvents&&(n=1==a.options.checkBoxSettings.threeState?angular.isDefined(c.events)&&c.events.itemCheckstateChanging?c.events.itemCheckstateChanging({item:b,value:d}):c.itemCheckstateChanging({e:{item:b,value:d}}):angular.isDefined(c.events)&&c.events.itemCheckedChanging?c.events.itemCheckedChanging({item:b,value:d}):c.itemCheckedChanging({e:{item:b,value:d}}));return n};this.callCheckValueChanged=function(b,d){a.allowEvents&&(retValue=1==a.options.checkBoxSettings.threeState?angular.isDefined(c.events)&&c.events.itemCheckstateChanged?c.events.itemCheckstateChanged({item:b,value:d}):c.itemCheckstateChanged({e:{item:b,value:d}}):angular.isDefined(c.events)&&c.events.itemCheckedChanged?c.events.itemCheckedChanged({item:b,value:d}):c.itemCheckedChanged({e:{item:b,value:d}}))};var H=[],q=!1;this.fillCheckList=function(b){if(b&&1==a.options.checkBoxSettings.threeState&&!q){q=!0;H.length=0;H.push({item:b,value:b[a.options.dataFields.checkState]});a.updateListChildItemCheckValue(b);a.updateListParentItemCheckValue(b);for(var d=0,d=0;d<H.length;d++)H[d].item[a.options.dataFields.checkState]=H[d].value;var c=e(function(){d==H.length&&(q=!1);e.cancel(c)},1)}};this.getItemCheckValue=function(b){for(var d="unchecked",c=!1,h=0;h<H.length;h++)if(H[h].item==b){c=!0;d=H[h].value;break}c||(d=b[a.options.dataFields.checkState]);return d};this.updateListParentItemCheckValue=function(b){for(b=a.getParent(b);b;){var d=b[a.options.dataFields.items];if(d){for(var c=0,h=0,f=0;f<d.length;f++){var e=a.getItemCheckValue(d[f]);"checked"==e?c++:"indeterminate"==e&&h++}f={item:b};f.value=c==d.length?"checked":0<c||0<h?"indeterminate":"unchecked";H.push(f)}b=a.getParent(b)}};this.updateListChildItemCheckValue=function(b){if(b){var d=b[a.options.dataFields.items];if(d)for(var c=0;c<d.length;c++){var h={item:d[c]};"checked"==a.getItemCheckValue(b)?h.value="checked":h.value="unchecked";H.push(h);a.updateListChildItemCheckValue(d[c])}}};this.updateParentItemCheckValue=function(b){for(b=a.getParent(b);b;){var d=b[a.options.dataFields.items];if(d){for(var c=0,h=0,f=0;f<d.length;f++)"checked"==d[f][a.options.dataFields.checkState]?c++:"indeterminate"==d[f][a.options.dataFields.checkState]&&h++;b[a.options.dataFields.checkState]=c==d.length?"checked":0<c||0<h?"indeterminate":"unchecked"}b=a.getParent(b)}};this.updateItemCheckValue=function(b,d){if("checked"==d||"unchecked"==d)b[a.options.dataFields.checkState]=d;var c=b[a.options.dataFields.items];if(c&&0<c.length)for(var h=0;h<c.length;h++)a.updateItemCheckValue(c[h],b[a.options.dataFields.checkState]);void 0!=b[a.options.dataFields.checkState]&&(c=a.getParent(b))&&c[a.options.dataFields.checkState]!=b[a.options.dataFields.checkState]&&a.updateParentItemCheckValue(b)};this.updateCheckValues=function(b){if(1==a.options.checkBoxSettings.threeState){b=a.dataObj.getList(b);for(var d=0;d<b.length;d++)a.updateItemCheckValue(b[d])}};c.$on(c.name+"-update-check",function(b,d){a.updateCheckValues(d)});c.$on(c.name+"-get-check-list",function(b,d){a.updateCheckValues();void 0==d&&(d=1==a.options.checkBoxSettings.threeState?"checked":!0);var c=1==a.options.checkBoxSettings.threeState?a.options.dataFields.checkState:a.options.dataFields.checked,h={operation:"=",value:d},c=ea.filter(a.getFullList(),c,h);g.setTempData(c)});this.updateCheckBoxSettings=function(b){a.options.checkBoxSettings=b?{autoCheck:f.isFieldAvailable(b.autoCheck,!1),style:B(b.style),threeState:f.isFieldAvailable(b.threeState,!1)}:{autoCheck:!1,style:a.defaultCheckBoxStyle,threeState:!1}};var y=function(a){return a?ea.createTree(a.conditions,a.formula):null},v=function(b){var d=!0;b&&a.filterParams&&(d=(d=b[a.options.dataFields.value])?d:b[a.options.dataFields.text],d=a.filterParams.callback?a.filterParams.callback(d,b):ea.match(d,a.filterParams.conditions,a.filterParams.formula,y(a.filterParams)));return d},t=a.options.indent,K=0;a.currentList=[];a.indentList=[];a.longestItem=null;a.isThereChildItems=!1;var J=function(b,d,c,h){b.type="item";b[a.options.dataFields.id]||(b[a.options.dataFields.id]=f.getUniqueId());c&&(b[a.options.dataFields.pid]=c);if(c=v(b))h?a.fullList.push(b):(a.currentList.push(b),a.indentList.push(d),b[a.options.dataFields.text]&&(d=b[a.options.dataFields.text].length+d/t,K<d&&(K=d,a.longestItem=b)));return c};this.isThereVisibleChildren=function(b){var d=!1;if(b&&(b=b[a.options.dataFields.items]))for(var c=0;c<b.length;c++)if(v(b[c])){d=!0;break}return d};this.isThereChildItems=!1;var F=function(b,d,c,h){var f=!0;if(!b[a.options.dataFields.items])return f=J(b,d,c,h);if(f=J(b,d,c,h)){c=0;var e=!0;if(h||S(b)){var g=b[a.options.dataFields.items];if(g){a.applySorting(g);for(var k=0;k<g.length;k++)(e=F(g[k],d+t,b[a.options.dataFields.id],h))&&c++}}h||a.isThereChildItems||!(0<c||!S(b)&&b[a.options.dataFields.items]&&0<b[a.options.dataFields.items].length&&a.isThereVisibleChildren(b))||(a.isThereChildItems=!0)}return f};a.fullList=[];this.getFullList=function(b){a.fullList.length=0;b=a.dataObj.getList(b);for(var d=0;d<b.length;d++)F(b[d],0,null,!0);return a.fullList};this.getCurrentList=function(){return a.currentList};this.updateCurrentList=function(){a.currentList.length=0;a.indentList.length=0;a.longestItem=null;a.isThereChildItems=!1;K=0;var b=a.dataObj.getList();if(b){a.applySorting(b);for(var d=0;d<b.length;d++)F(b[d],0,null,!1)}};this.dataEvents={clear:function(a){return angular.isDefined(c.events)&&c.events.clear?c.events.clear({parent:a.e.parent}):c.clear(a)},objAdded:function(a){return angular.isDefined(c.events)&&c.events.itemAdded?c.events.itemAdded({item:a.e.item}):c.itemAdded(a)},objAdding:function(a){return angular.isDefined(c.events)&&c.events.itemAdding?c.events.itemAdding({item:a.e.item}):c.itemAdding(a)},objRemoved:function(a){return angular.isDefined(c.events)&&c.events.itemRemoved?c.events.itemRemoved({item:a.e.item}):c.itemRemoved(a)},objRemoving:function(a){return angular.isDefined(c.events)&&c.events.itemRemoving?c.events.itemRemoving({item:a.e.item}):c.itemRemoving(a)}};this.getDataFields=function(a){return{content:a.content?a.content:"content",icon:a.icon?a.icon:"icon",id:a.id?a.id:"id",pid:a.pid?a.pid:"pid",objects:a.items?a.items:"items",statusIcon:a.statusIcon?a.statusIcon:"statusIcon",text:a.text?a.text:"text"}};a.dataObj=new D({objects:c.items,events:a.dataEvents,fields:a.getDataFields(a.options.dataFields)});c.$on(c.name+"-load-data",function(b,d,c,h,f){a.loadData(d,c,h,f)});c.$on(c.name+"-export-json",function(b,d,c,h){g.setTempData(a.exportToJSON(d,c,h))});this.exportToJSON=function(b,d,c){c=c?c:null;var h=!1!==d?a.getFullList():a.dataObj.getList();b=b?b:[a.options.dataFields.allowDrag,a.options.dataFields.allowDrop,a.options.dataFields.allowEdit,a.options.dataFields.allowFocus,a.options.dataFields.autoCheck,a.options.dataFields.checkBoxSettings,a.options.dataFields.checked,a.options.dataFields.checkState,a.options.dataFields.content,a.options.dataFields.enabled,a.options.dataFields.expanded,a.options.dataFields.hasChildren,a.options.dataFields.icon,a.options.dataFields.id,a.options.dataFields.pid,a.options.dataFields.statusIcon,a.options.dataFields.style,a.options.dataFields.text,a.options.dataFields.value];!1===d&&b.push(a.options.dataFields.items);return JSON.stringify(h,b,c)};this.loadData=function(b,d,n,h){a.allowEvents=!1;a.updateDataFields(n);var f=[],e=a.options.dataFields;a.dataObj.clear(d,a.listIsCleared);if(b)if(0!=h){var g=[];b.forEach(function(a,b){var d=a[e.pid];g[d]?(g[d][e.items]||(g[d][e.items]=[]),g[a[e.id]]=a,g[d][e.items].push(a)):(g[a[e.id]]=a,f.push(a))});g.length=0}else f=b;if(d)for(d[a.options.dataFields.items]=f,b=0;b<d[a.options.dataFields.items].length;b++)d[a.options.dataFields.items][b][a.options.dataFields.pid]=d[a.options.dataFields.id];else angular.isDefined(c.items)&&(c.items=f);a.dataObj=new D({objects:c.items,events:a.dataEvents,fields:a.getDataFields(a.options.dataFields)});a.updateLayout();a.allowEvents=!0};this.updateData=function(){a.options.dataFields.dataSource&&(a.loadData(a.options.dataFields.dataSource),a.dataObj=new D({objects:c.items,events:a.dataEvents,fields:a.getDataFields(a.options.dataFields)}))};var N=!1;this.dragDropStatus=function(a){if(a)N=a;else return N};this.getDnDSource=function(a){return{text:a.dataTransfer?a.dataTransfer.getData("text"):a.originalEvent.dataTransfer?a.originalEvent.dataTransfer.getData("text"):""}};var r=angular.element('<div class="iui-drop-marker" data-element="dropmark"></div>');this.getDropMarkLine=function(){return dropMarkLine};angular.element(k).bind("dragenter",function(b){a.dropMark()});angular.element(k).bind("dragend",function(b){a.removeDropMark();a.dragIcon&&angular.element(a.dragIcon).remove();a.cancelScrollTimer()});a.getMousePos=function(a){return{x:a.pageX?a.pageX:a.originalEvent?a.originalEvent.pageX:0,y:a.pageY?a.pageY:a.originalEvent?a.originalEvent.pageY:0}};this.getTreeName=function(){return angular.isDefined(c.name)?c.name:""};l.bind("dragenter",function(b){b.preventDefault();var d=m.getData();d.source||(d.source=a.getDnDSource(b));b={sourceTree:d.sourceCtrl?d.sourceCtrl.getTreeName():"",dragItem:d.source,targetTree:a.getTreeName(),targetItem:d.target,mousePos:a.getMousePos(b)};a.callDragEnter(b)});l.bind("dragover",function(b){b.preventDefault();var d=!0;b.dataTransfer?d="none"===b.dataTransfer.effectAllowed?!1:!0:b.originalEvent&&b.originalEvent.dataTransfer&&(d="none"===b.originalEvent.dataTransfer.effectAllowed?!1:!0);if(d){b.dataTransfer?b.dataTransfer.dropEffect=a.options.allowDrop?"move":"none":b.originalEvent&&b.originalEvent.dataTransfer&&(b.originalEvent.dataTransfer.dropEffect=a.options.allowDrop?"move":"none");d=m.getData();d.source||(d.source=a.getDnDSource(b));m.setData({source:d.source,sourceCtrl:d.sourceCtrl,target:null,dropPos:-1});d={sourceTree:d.sourceCtrl?d.sourceCtrl.getTreeName():"",dragItem:d.source,targetTree:a.getTreeName(),targetItem:null,isDropAllowed:a.options.allowDrop,dropPos:-1,mousePos:a.getMousePos(b)};a.callDragOver(d);d=a.getMousePos(b);b=d.y+16;var d=d.x+20,n=a.getDropMarkWindow();n.empty();n.append("<span class='iui-drop-marker-move-end'></span><span class='iui-drop-marker-title'>"+(c.name?c.name:"TreeView")+"</span>");a.updateDropMarkElem(a.getDropMarkWindow(),{top:b,left:d});a.dropMark(!0)}});l.bind("drop",function(b){b.preventDefault();a.dropMark();var d=!0;b.dataTransfer?d="none"===b.dataTransfer.effectAllowed?!1:!0:b.originalEvent&&b.originalEvent.dataTransfer&&(d="none"===b.originalEvent.dataTransfer.effectAllowed?!1:!0);if(d&&(d=m.getData(),d.source||(d.source=a.getDnDSource(b)),d.source)){var n={sourceTree:d.sourceCtrl?d.sourceCtrl.getTreeName():"",dragItem:d.source,targetTree:a.getTreeName(),targetItem:null,isDropAllowed:a.options.allowDrop,dropPos:-1,mousePos:a.getMousePos(b)};!1!==a.callDragDrop(n)&&(a.drop(d),c.$$phase||c.$apply())}m.clearData();b.stopPropagation()});l.bind("dragleave",function(b){b.preventDefault();a.dropMark();var d=m.getData();d.source||(d.source=a.getDnDSource(b));b={sourceTree:d.sourceCtrl?d.sourceCtrl.getTreeName():"",dragItem:d.source,targetTree:a.getTreeName(),targetItem:d.target,mousePos:a.getMousePos(b)};a.callDragLeave(b);a.cancelScrollTimer()});l.bind("dragend",function(b){b.preventDefault();a.dropMark();m.getData().source||m.clearData()});l.bind("mouseleave",function(b){b.preventDefault();a.dropMark();a.hoverItem=null});this.containsMousePos=function(a,d){return m.hitTest(a,d,{left:0,top:0,right:l[0].clientWidth,bottom:l[0].clientHeight})};this.isPopupActive=function(){return!1};var ga=function(b,d){var c=a.options.dataFields;b[c.items]||(b[c.items]=[]);b[c.items].length=0;if(b[d.rows]&&0<b[d.rows].length)for(var h=0;h<b[d.rows].length;h++)b[c.items].push(ga(b[d.rows][h],d));return b},V=function(b,d){var c=!1;d.sourceCtrl&&(c=d.sourceCollection.removeAt(b,-1,null,d.sourceCtrl.objIsRemoved));c&&("row"==b.type&&(b=ga(b,d.sourceCtrl.options.rowFields)),0===d.dropPos?a.dataObj.insertAt(b,-1,d.target,a.itemIsAdded):1===d.dropPos||2===d.dropPos?1===d.dropPos?a.dataObj.insertByRef(b,d.target,!1,a.itemIsAdded):a.dataObj.insertByRef(b,d.target,!0,a.itemIsAdded):a.dataObj.insertAt(b,-1,null,a.itemIsAdded))};this.setDropSelection=function(b,d){var c=b;!c&&0<=d&&d<a.currentList.length&&(c=a.currentList[d]);a.clearPrevSelection(c);a.itemSelection(c)};this.drop=function(b){if(b&&b.sourceCtrl){b.sourceCtrl.suppressProcess=!0;b.sourceCtrl.suspendLayout();a.suspendLayout();var d=b.source;if(Array.isArray(b.source)){for(var n=[],h=0;h<b.source.length;h++){for(var f=!1,g=b.sourceCollection.getParent(b.source[h]);g;){if(b.sourceCtrl.isObjInSelList(g)){f=!0;break}g=b.sourceCollection.getParent(g)}f||n.push(b.source[h])}if(0<n.length)if(d=n[n.length-1],h=b.sourceCtrl.getObjCurrentIndex(n[0]),f=b.sourceCtrl.getObjCurrentIndex(d),h<=f)for(h=0;h<n.length;h++)V(n[h],b);else for(h=n.length-1;0<=h;h--)V(n[h],b)}else V(b.source,b);b.sourceCtrl!==a?(a.resumeLayout(),b.sourceCtrl.resumeLayout()):a.resumeLayout();b.sourceCtrl.multiSelection(!1);var k=e(function(){if(d){b.sourceCtrl.clearPrevSelection(d);a.itemSelection(d);var n=a.getElemFromItem(d);n&&(n=a.getElement(n))&&n[0].focus();c.$apply();e.cancel(k)}},1);b.sourceCtrl.suppressProcess=!1}};this.isDragAllowed=function(b){return a.options.allowDrag?b&&(b[a.options.dataFields.allowDrag]||void 0===b[a.options.dataFields.allowDrag])?!0:!1:!1};this.isChildOf=function(b,d){var c=!1;if(b&&d){var h=d[a.options.dataFields.items];if(h&&0<h.length)for(var e=0;e<h.length;e++){if(f.isEqual(b[a.options.dataFields.id],h[e][a.options.dataFields.id])){c=!0;break}else c=a.isChildOf(b,h[e]);if(c)break}}return c};this.isParentOf=function(b,d){var c=a.dataObj.getParent(d);return b&&d&&c&&f.isEqual(b[a.options.dataFields.id],c[a.options.dataFields.id])?!0:!1};this.isDropAllowed=function(b,d,c){var h=a.options.allowDrop;if(h&&b&&d&&(h=d[a.options.dataFields.allowDrop]||void 0===d[a.options.dataFields.allowDrop]?!0:!1))if(Array.isArray(b))for(var e=0;e<b.length;e++){if(f.isEqual(b[e][a.options.dataFields.id],d[a.options.dataFields.id])||0===c&&a.isParentOf(d,b[e])||a.isChildOf(d,b[e])){h=!1;break}if(!h)break}else if(f.isEqual(b[a.options.dataFields.id],d[a.options.dataFields.id])||0===c&&a.isParentOf(d,b)||a.isChildOf(d,b))h=!1;return h};this.getDropMarkWindow=function(){for(var a=r,d=angular.element(document.body).children(),c=0;c<d.length;c++){var h=angular.element(d[c]);if(h[0].attributes&&h[0].attributes["data-element"]&&"dropmark"===h[0].attributes["data-element"].value){a=h;break}}return a};this.dropMark=function(b,d){d||(d=a.getDropMarkWindow());if(d){var c="none";this.options.allowDrop&&(c=b?"block":"none");angular.element(d).css("display",c)}};this.updateDropMarkElem=function(a,d){a&&d&&(a.css("top",d.top+"px"),a.css("left",d.left+"px"),a.css("width",d.width+"px"))};var ha=!1,O=angular.element('<input type="text" style="position:absolute" />');this.labelEditStatus=function(a){if(void 0!=a)ha=a;else return ha};this.getEditBox=function(){return O};this.updateEditBox=function(a){O&&a&&(O.css("top",a.top+"px"),O.css("left",a.left+"px"),O.css("width",a.width+"px"),O.css("height",a.height+"px"))};c.$on(c.name+"-open-editor",function(b,d){a.openEditor(d)});c.$on(c.name+"-close-editor",function(b,d){a.closeEditor(d)});this.updateEditorSettings=function(b){a.options.editorSettings=b?{activate:f.isFieldAvailable(b.activate,"click")}:{activate:"click"}};this.allowEvents=!0;this.callAfterCollapse=function(a){angular.isDefined(c.events)&&c.events.afterCollapse&&c.events.afterCollapse({item:a});c.afterCollapse({e:{item:a}})};this.callAfterExpand=function(a){angular.isDefined(c.events)&&c.events.afterExpand&&c.events.afterExpand({item:a});c.afterExpand({e:{item:a}})};this.callAfterEdit=function(a){angular.isDefined(c.events)&&c.events.afterEdit&&c.events.afterEdit({item:a});c.afterEdit({e:{item:a}})};this.callAfterLabelEdit=function(a){angular.isDefined(c.events)&&c.events.afterLabelEdit&&c.events.afterLabelEdit({item:a});c.afterLabelEdit({e:{item:a}})};this.callAfterSelect=function(a){angular.isDefined(c.events)&&c.events.afterSelect?c.events.afterSelect({item:a}):c.afterSelect({e:{item:a}});angular.isDefined(c.events)&&c.events.selectionChanged?c.events.selectionChanged({item:a}):c.selectionChanged({e:{item:a}})};this.callBeforeCollapse=function(a){var d=!0;return d=angular.isDefined(c.events)&&c.events.beforeCollapse?c.events.beforeCollapse({item:a}):c.beforeCollapse({e:{item:a}})};this.callBeforeExpand=function(a){var d=!0;return d=angular.isDefined(c.events)&&c.events.beforeExpand?c.events.beforeExpand({item:a}):c.beforeExpand({e:{item:a}})};this.callBeforeEdit=function(a){var d=!0;return d=angular.isDefined(c.events)&&c.events.beforeEdit?c.events.beforeEdit({item:a}):c.beforeEdit({e:{item:a}})};this.callBeforeLabelEdit=function(a){var d=!0;return d=angular.isDefined(c.events)&&c.events.beforeLabelEdit?c.events.beforeLabelEdit({item:a}):c.beforeLabelEdit({e:{item:a}})};this.callDragEnter=function(a){angular.isDefined(c.events)&&c.events.dragEnter?c.events.dragEnter({sourceTree:a.sourceTree,dragItem:a.dragItem,targetTree:a.targetTree,targetItem:a.targetItem,mousePos:a.mousePos}):c.dragEnter({e:{sourceTree:a.sourceTree,dragItem:a.dragItem,targetTree:a.targetTree,targetItem:a.targetItem,mousePos:a.mousePos}})};this.callDragOver=function(a){var d=!0;return d=angular.isDefined(c.events)&&c.events.dragOver?c.events.dragOver({sourceTree:a.sourceTree,dragItem:a.dragItem,targetTree:a.targetTree,targetItem:a.targetItem,isDropAllowed:a.isDropAllowed,dropPos:a.dropPos,mousePos:a.mousePos}):c.dragOver({e:{sourceTree:a.sourceTree,dragItem:a.dragItem,targetTree:a.targetTree,targetItem:a.targetItem,isDropAllowed:a.isDropAllowed,dropPos:a.dropPos,mousePos:a.mousePos}})};this.callDragDrop=function(a){var d=!0;return d=angular.isDefined(c.events)&&c.events.dragDrop?c.events.dragDrop({sourceTree:a.sourceTree,dragItem:a.dragItem,targetTree:a.targetTree,targetItem:a.targetItem,isDropAllowed:a.isDropAllowed,dropPos:a.dropPos,mousePos:a.mousePos}):c.dragDrop({e:{sourceTree:a.sourceTree,dragItem:a.dragItem,targetTree:a.targetTree,targetItem:a.targetItem,isDropAllowed:a.isDropAllowed,dropPos:a.dropPos,mousePos:a.mousePos}})};this.callDragLeave=function(a){angular.isDefined(c.events)&&c.events.dragLeave?c.events.dragLeave({sourceTree:a.sourceTree,dragItem:a.dragItem,targetTree:a.targetTree,targetItem:a.targetItem,mousePos:a.mousePos}):c.dragLeave({e:{sourceTree:a.sourceTree,dragItem:a.dragItem,targetTree:a.targetTree,targetItem:a.targetItem,mousePos:a.mousePos}})};this.callItemClick=function(a,d){angular.isDefined(c.events)&&c.events.itemClick&&c.events.itemClick({item:a,mousePos:d});c.itemClick({e:{item:a,mousePos:d}})};this.callItemDblClick=function(a,d){angular.isDefined(c.events)&&c.events.itemDblClick&&c.events.itemDblClick({item:a,mousePos:d});c.itemDblclick({e:{item:a,mousePos:d}});return!0};this.callItemHover=function(a){angular.isDefined(c.events)&&c.events.itemHover?c.events.itemHover({item:a}):c.itemHover({e:{item:a}})};this.callItemRightClick=function(a,d){angular.isDefined(c.events)&&c.events.itemRightClick&&c.events.itemRightClick({item:a,mousePos:d});c.itemRightclick({e:{item:a,mousePos:d}})};this.callKeyDown=function(a,d){angular.isDefined(c.events)&&c.events.keyDown?c.events.keyDown({event:a,item:d}):c.keyDown({e:{event:a,item:d}})};this.callKeyPress=function(a,d){angular.isDefined(c.events)&&c.events.keyPress?c.events.keyPress({event:a,item:d}):c.keyPress({e:{event:a,item:d}})};this.callKeyUp=function(a,d){angular.isDefined(c.events)&&c.events.keyUp?c.events.keyUp({event:a,item:d}):c.keyUp({e:{event:a,item:d}})};l.bind("click",function(b){1===b.which&&a.callItemClick(null,a.getMousePos(b))});l.bind("dblclick",function(b){b.preventDefault();1===b.which&&a.callItemDblClick(null,a.getMousePos(b));b.stopPropagation()});l.bind("mousedown",function(b){3===b.which&&a.callItemRightClick(null,a.getMousePos(b));b.stopPropagation()});this.toggle=function(b,d){if(b){if(b[a.options.dataFields.hasChildren]||b[a.options.dataFields.items]&&0!==b[a.options.dataFields.items].length)if(!d||!1===b[a.options.dataFields.expanded])if(!1!==d||!1!==b[a.options.dataFields.expanded]){var c=void 0!==d?d:!1!==b[a.options.dataFields.expanded]?!0:!1,h=!0,h=void 0!==d?d?a.callBeforeExpand(b):a.callBeforeCollapse(b):c?a.callBeforeCollapse(b):a.callBeforeExpand(b);!1!==h&&(h=b[a.options.dataFields.expanded],b[a.options.dataFields.expanded]=void 0!==d?d:!c,b[a.options.dataFields.expanded]?a.callAfterExpand(b):a.callAfterCollapse(b),h!==b[a.options.dataFields.expanded]&&a.updateLayout())}}else{a.suspendLayout();c=a.getFullList();for(h=0;h<c.length;h++)a.toggle(c[h],d);a.resumeLayout()}};c.$on(c.name+"-begin-load",function(b,d){a.options.loadItem=d});c.$on(c.name+"-collapse",function(b,d){a.toggle(d,!1)});c.$on(c.name+"-end-load",function(b){a.options.loadItem=null});c.$on(c.name+"-expand",function(b,d){a.toggle(d,!0)});c.$on(c.name+"-toggle",function(b,d){a.toggle(d)});this.filterParams=null;c.$on(c.name+"-filter",function(b,d){a.filter(d)});this.filter=function(b){a.filterParams=b;a.updateLayout()};this.callGotFocus=function(a,d,f,h){angular.isDefined(c.events)&&c.events.gotFocus?c.events.gotFocus({event:a,item:d,edit:void 0!=f?!0:!1,editValue:h}):c.gotFocus({e:{event:a,item:d,edit:void 0!=f?!0:!1,editValue:h}})};this.callLostFocus=function(a,d,f,h){angular.isDefined(c.events)&&c.events.lostFocus?c.events.lostFocus({event:a,item:d,edit:void 0!=f?!0:!1,editValue:h}):c.lostFocus({e:{event:a,item:d,edit:void 0!=f?!0:!1,editValue:h}})};this.getTabIndex=function(){return l[0].attributes&&l[0].attributes.tabindex?l[0].attributes.tabindex.value:""};this.updateFocus=function(b){if(1==a.options.allowFocus)var d=e(function(){if(b){var c=a.getElemFromItem(b);c&&(c=a.getElement(c))&&c[0].focus()}else l[0].focus();e.cancel(d)},5)};c.$on(c.name+"-focus",function(b,d){a.updateFocus(d)});var W=!1,S=function(b){return b?b[a.options.dataFields.expanded]||void 0===b[a.options.dataFields.expanded]?!0:!1:!0};this.getElement=function(a,d){var c=null;d||(d="content");if(a)for(var f=a.children(),e=0;e<f.length;e++){var g=angular.element(f.eq(e));if(g[0].attributes&&g[0].attributes["data-element"]&&g[0].attributes["data-element"].value===d){c=g;break}}return c};this.getElemFromItem=function(b){var d=null;if(b){b=a.getItemCurrentIndex(b);var c=l.find("li");if(c&&0<c.length)for(var f=0;f<c.length;f++){var e=angular.element(c[f]);if(e[0].attributes["data-index"]&&e[0].attributes["data-index"].value.toString()===b.toString()){d=e;break}}}return d};this.getIndent=function(b){var d=0;if(b)for(parent=a.dataObj.getParent(b);parent;)d+=a.options.indent,parent=a.dataObj.getParent(parent);return d};this.getItemCurrentIndex=function(b){return b&&a.currentList?a.currentList.indexOf(b):-1};this.getObjCurrentIndex=function(b){return a.getItemCurrentIndex(b)};this.getObjState=function(b){if(b)switch(b.type){case "item":if(0==b[a.options.dataFields.enabled])return"disabled";if(1==b.selected&&a.isObjInSelList(b))return"selected";if(b==a.hoverItem)return"hovered"}return"normal"};this.getItemFromChildElem=function(b){return b?(b=angular.element(b))?a.getItemFromElem(b[0].parentElement):null:null};this.getItemFromElem=function(b){if(b&&(b=angular.element(b))&&b[0].attributes["data-index"]&&(b=b[0].attributes["data-index"].value,a.isIndexInRange(b)))return a.currentList[b]};this.isIndexInRange=function(b){return 0<=b&&b<a.currentList.length};this.isItemEnabled=function(b){return f.isEnabled(b[a.options.dataFields.enabled])};this.mouseButtonStatus=function(a){W=a};c.$on(c.name+"-ensure-visible",function(b,d,c){a.ensureVisible(d,c)});c.$on(c.name+"-find-item-by-id",function(b,d){g.setTempData(a.findItemById(d))});c.$on(c.name+"-find-item-by-text",function(b,d){g.setTempData(a.findItemByText(d))});c.$on(c.name+"-get-full-path",function(b,d){g.setTempData(a.getFullPath(d))});c.$on(c.name+"-get-item-level",function(b,d){g.setTempData(a.getLevel(d))});c.$on(c.name+"-get-item-parent",function(b,d){g.setTempData(a.getParent(d))});c.$on(c.name+"-get-flat-list",function(b,d){d?g.setTempData(a.getFullList()):g.setTempData(a.currentList)});c.$on(c.name+"-get-list",function(b,d,c){1==c?g.setTempData(a.getFullList(d)):g.setTempData(a.getList(d))});this.ensureVisible=function(b,d){if(b){a.suspendLayout();for(var c=[],f=a.getParent(b);f;)c.push(f),f=a.getParent(f);for(f=c.length-1;0<=f;f--)a.toggle(c[f],!0);a.resumeLayout();d||(d="center");a.scrollTo(b,d)}};this.findItemById=function(b){return a.dataObj.findObjectById(b)};this.findItemByText=function(b){return a.dataObj.findObjectByText(b)};this.getFullPath=function(b){var d="";if(b)for(d=b[a.options.dataFields.text],b=a.getParent(b);b;)d=[b[a.options.dataFields.text],a.options.pathSeparator,d].join(""),b=a.getParent(b);return d};this.getLevel=function(a){var d=0;for(a=this.getParent(a);a;)d++,a=this.getParent(a);return d};this.getParent=function(b){return a.dataObj.getParent(b)};this.getList=function(b){return a.dataObj.getList(b)};this.getFirstItem=function(){for(var b=null,d=0;d<a.currentList.length;d++)if(a.isItemEnabled(a.currentList[d])){b=a.currentList[d];break}return b};this.getPrevItem=function(b){var d=null;if(0<=b&&b<a.currentList.length)for(--b;0<=b;b--)if(a.isItemEnabled(a.currentList[b])){d=a.currentList[b];break}return d};this.getNextItem=function(b){var d=null;for(b+=1;b<a.currentList.length;b++)if(a.isItemEnabled(a.currentList[b])){d=a.currentList[b];break}return d};this.getLastItem=function(){for(var b=null,d=a.currentList.length-1;0<=d;d--)if(a.isItemEnabled(a.currentList[d])){b=a.currentList[d];break}return b};this.updateSelectionStatus=function(b){switch(b){case "shift":switch(a.options.selectionMode){case "multi-simple":a.multiSelection(!0);a.shiftKeyStatus(!1);break;case "multi-extended":a.multiSelection(!0);a.shiftKeyStatus(!0);break;default:a.multiSelection(!1),a.shiftKeyStatus(!1)}break;case "ctrl":switch(a.options.selectionMode){case "multi-simple":a.multiSelection(!0);break;case "multi-extended":a.multiSelection(!0);break;default:a.multiSelection(!1)}}};l.bind("keydown",function(b){switch(b.keyCode){case 16:a.updateSelectionStatus("shift");break;case 17:a.updateSelectionStatus("ctrl");break;default:(b.ctrlKey||b.metaKey)&&a.updateSelectionStatus("ctrl"),b.shiftKey&&a.updateSelectionStatus("shift")}});a.allowUpdate=!0;this.suspendLayout=function(){a.allowUpdate=!1};this.resumeLayout=function(){a.allowUpdate=!0;a.updateLayout()};c.$on(c.name+"-refresh",function(b,d,c){a.refresh(d,c)});c.$on(c.name+"-resume-layout",function(b){a.resumeLayout()});c.$on(c.name+"-suspend-layout",function(b){a.suspendLayout()});c.$on(c.name+"-update-layout",function(b){a.updateLayout()});c.$on(c.name+"-update-view",function(b){a.updateView()});c.$on(c.name+"-get-scroll-pos",function(b){g.setTempData(a.getScrollPos())});c.$on(c.name+"-set-scroll-pos",function(b,d){a.setScrollPos(d)});c.$on(c.name+"-scroll-to",function(b,d,c){a.scrollTo(d,c)});var L=!1,G=!1;this.shiftKeyStatus=function(a){if(void 0!=a)L=a;else return L};this.multiSelection=function(a){if(void 0!=a)G=a;else return G};this.isItemSelected=function(a){return f.isSelected(a)};this.clearPrevSelection=function(b){for(var d=0;d<a.options.selectedItems.length;d++)b&&!f.isEqual(a.options.selectedItems[d][a.options.dataFields.id],b[a.options.dataFields.id])?a.options.selectedItems[d].selected=!1:b||(a.options.selectedItems[d].selected=!1);a.options.selectedItems.length=0;b&&a.isItemEnabled(b)&&a.options.selectedItems.push(b);a.refresh()};this.itemSelection=function(b,d){if(b){if("none"!==a.options.selectionMode)if(a.isItemEnabled(b)){var e=a.itemSelection(),h=!0;e&&(h=!f.isEqual(e[a.options.dataFields.id],b[a.options.dataFields.id]));var g=!0,g=angular.isDefined(c.events)&&c.events.beforeSelect?c.events.beforeSelect({item:b}):c.beforeSelect({e:{item:b}});if(!1!==g)if(h){h=!0;"multi-extended"===a.options.selectionMode&&(h=!a.isObjInSelList(b));h&&(W&&L?a.clearPrevSelection():G||"multi-simple"===a.options.selectionMode||a.clearPrevSelection());a.options.selectedItem=b;if(W&&L){if(h=a.getItemCurrentIndex(e),e=a.getItemCurrentIndex(b),h>e&&(g=h,h=e,e=g),a.isIndexInRange(h)&&a.isIndexInRange(e))for(;h<=e;h++)a.currentList[h].selected=!0,a.options.selectedItems.push(a.currentList[h])}else W&&(G||"multi-simple"===a.options.selectionMode)?(e=null===b.selected||"undefined"===b.selected?!1:b.selected,b.selected=!e,b.selected?a.isObjInSelList(b)||a.options.selectedItems.push(b):a.options.selectedItems=a.options.selectedItems.filter(function(a){return a!=b})):(b.selected=!0,a.isObjInSelList(b)||a.options.selectedItems.push(b));angular.isDefined(c.selectedItem)&&(c.selectedItem=b);a.callAfterSelect(b);a.refresh()}else if(G||"multi-simple"===a.options.selectionMode)e=null===b.selected||"undefined"===b.selected?!1:b.selected,d&&"undefined"!==d&&(e=d),b.selected=!e,b.selected?a.isObjInSelList(b)||a.options.selectedItems.push(b):a.options.selectedItems=a.options.selectedItems.filter(function(a){return a!=b}),a.callAfterSelect(b),a.refresh()}else a.clearPrevSelection()}else return a.options.selectedItem};this.updateSelection=function(b){"multi-simple"!==a.options.selectionMode&&0<a.options.selectedItems.length&&!L&&!G&&a.clearPrevSelection(b)};this.selectFirstItem=function(){for(var b=null,d=0;d<a.currentList.length;d++)if(a.isItemEnabled(a.currentList[d])){b=a.currentList[d];break}this.itemSelection(b);return a.options.selectedItem};this.isObjInSelList=function(b){var d=!1,c=a.options.selectedItems;if(b&&c)for(var e=0;e<c.length;e++)if(f.isEqual(c[e][a.options.dataFields.id],b[a.options.dataFields.id])){d=!0;break}return d};this.getItemAt=function(b,d){var c=null,e=null,g=null,k=l.find("li");if(k&&0<k.length)for(var m=0;m<k.length;m++)if(c=angular.element(k[m]),e=f.getPageRect(c),f.checkHit(b,d,e)){g=a.getItemFromElem(c);break}return g};this.resetSelection=function(){switch(a.options.selectionMode){case "none":a.clearPrevSelection();break;default:a.clearPrevSelection(a.itemSelection())}};c.$on(c.name+"-clear-selection",function(b){a.clearPrevSelection();a.options.selectedItem=null});c.$on(c.name+"-get-selected-item",function(b){g.setTempData(a.itemSelection())});c.$on(c.name+"-set-selected-item",function(b,d){a.itemSelection(d)});c.$on(c.name+"-get-selected-items",function(b){g.setTempData(a.options.selectedItems)});c.$watch("options",function(b,d){b!==d&&(a.updateOptions(b),a.updateLayout())},!0);c.$watch("allowDrag",function(b,d){b!==d&&(a.options.allowDrag=b,a.updateView())});c.$watch("allowDrop",function(b,d){b!==d&&(a.options.allowDrop=b,a.updateView())});c.$watch("allowFocus",function(b,d){b!==d&&(a.options.allowFocus=b)});c.$watch("autoCheck",function(b,d){b!==d&&(a.options.autoCheck=b,a.updateView())});c.$watch("autoExpand",function(b,d){b!==d&&(a.options.autoExpand=b)});c.$watch("checkBoxSettings",function(b,d){b!==d&&a.updateCheckBoxSettings(b)});c.$watch("controlStyle",function(b,d){b!==d&&a.updateControlStyle(b)});c.$watch("editorSettings",function(b,d){b!==d&&a.updateEditorSettings(b)});c.$watch("fields",function(b,d){b!==d&&(a.options.dataFields=b,a.UpdateData())});c.$watch("hoverSelection",function(b,d){b!==d&&(a.options.hoverSelection=b)});c.$watch("itemIcon",function(b,d){b!==d&&(a.options.itemIcon=b,a.updateLayout())});c.$watch("labelEdit",function(b,d){b!==d&&(a.options.labelEdit=b)});c.$watch("pathSeparator",function(b,d){b!==d&&(a.options.pathSeparator=b)});c.$watch("rtl",function(b,d){b!==d&&(a.options.rtl=b,a.updateLayout())});c.$watch("selectionMode",function(b,d){b!==d&&(a.options.selectionMode=b,a.resetSelection())});c.$watch("showCheckBoxes",function(b,d){b!==d&&(a.options.showCheckBoxes=b,a.updateLayout())});c.$watch("showIcons",function(b,d){b!==d&&(a.options.showIcons=b,a.updateLayout())});c.$watch("showStatusIcons",function(b,d){b!==d&&(a.options.showStatusIcons=b,a.updateLayout())});c.$watch("selectedItem",function(b,d){b!==d&&(d&&(d.selected=!1),a.options.selectedItem=b,a.callAfterSelect(b))});this.sortComparer=null;c.$watch("sorting",function(b,d){b!==d&&(a.options.sorting=b)});c.$on(c.name+"-sort",function(b,d,c){a.sort(d,c)});this.sort=function(b,d){a.sortComparer=d;if("ascending"==b||"descending"==b||"none"==b)a.options.sorting=b;a.updateLayout()};this.isSortingAllowed=function(){return"ascending"==a.options.sorting||"descending"==a.options.sorting};this.applySorting=function(b){b&&(a.sortComparer?b.sort(a.sortComparer):a.isSortingAllowed()&&b.sort(function(b,c){var e=null,g=null;(e=b[a.options.dataFields.value])||(e=b[a.options.dataFields.text]);f.isObject(e)&&(e=e.value?e.value:e.text);(g=c[a.options.dataFields.value])||(g=c[a.options.dataFields.text]);f.isObject(g)&&(g=g.value?g.value:g.text);e=void 0!=e?e:null;g=void 0!=g?g:null;switch(a.options.sorting){case "ascending":if(e<g)return-1;if(e>g)return 1;break;case "descending":if(e>g)return-1;if(e<g)return 1;break;default:return 0}}))};var B=function(b){if(b){var d=f.isFieldAvailable(b.general,"iui-checkbox");b=(b=b.box)?{general:f.isFieldAvailable(b.general,"iui-checkbox-box"),disabled:f.isFieldAvailable(b.disabled,"iui-checkbox-disabled"),checked:f.isFieldAvailable(b.checked,"iui-checkbox-checked"),indeterminate:f.isFieldAvailable(b.indeterminate,"iui-checkbox-indeterminate"),unchecked:f.isFieldAvailable(b.unchecked,"iui-checkbox-unchecked")}:a.options.controlStyle.item.checkBox.box;return{general:d,box:b}}return a.options.controlStyle.item.checkBox};this.getExpandBoxStyle=function(b){return b?{general:f.isFieldAvailable(b.general,"iui-treeview-expand-box"),animated:f.isFieldAvailable(b.animated,"iui-treeview-expand-box-load"),expanded:f.isFieldAvailable(b.expanded,"iui-treeview-expand-box-open"),collapsed:f.isFieldAvailable(b.collapsed,"iui-treeview-expand-box-close")}:a.options.controlStyle.item.expandBox};var C=function(b){if(b){var d;d=b.general;d=f.isString(d)?d:d?{disabled:f.isFieldAvailable(d.disabled,"iui-treeview-item-disabled"),focused:f.isFieldAvailable(d.focused,"iui-treeview-item-focused"),normal:f.isFieldAvailable(d.normal,"iui-treeview-item"),hovered:f.isFieldAvailable(d.hovered,"iui-treeview-item-hovered"),selected:f.isFieldAvailable(d.selected,"iui-treeview-item-selected")}:a.options.controlStyle.item.general;var c=B(b.checkBox),e=a.getExpandBoxStyle(b.expandBox);b=b.content;b=f.isString(b)?b:b?{disabled:f.isFieldAvailable(b.disabled,"iui-treeview-item-content-disabled"),focused:f.isFieldAvailable(b.focused,"iui-treeview-item-content-focused"),normal:f.isFieldAvailable(b.normal,"iui-treeview-item-content"),hovered:f.isFieldAvailable(b.hovered,"iui-treeview-item-content-hovered"),selected:f.isFieldAvailable(b.selected,"iui-treeview-item-content-selected")}:a.options.controlStyle.item.content;return{general:d,checkBox:c,expandBox:e,content:b}}return a.options.controlStyle.item};this.updateControlStyle=function(b){a.options.controlStyle=b?{general:f.isFieldAvailable(b.general,"iui-treeview"),item:C(b.item)}:{general:f.isFieldAvailable(a.defaultStyle.general,"iui-treeview"),item:C(a.defaultStyle.item)}};this.getCurrentItemStyle=function(b,d){var c=a.options.controlStyle.item;if(b)switch(b.style){case "initial":break;case "parent":return a.getCurrentItemStyle(a.getParent(b),d);default:null!=b.style&&(c=b.style)}if(d){if(f.isString(c.general))return c.general;switch(d){case "disabled":return c.general&&c.general.disabled?c.general.disabled:a.options.controlStyle.item.general.disabled;case "focused":return c.general&&c.general.focused?c.general.focused:a.options.controlStyle.item.general.focused;case "hovered":return c.general&&c.general.hovered?c.general.hovered:a.options.controlStyle.item.general.hovered;case "selected":return c.general&&c.general.selected?c.general.selected:a.options.controlStyle.item.general.selected;default:return c.general&&c.general.normal?c.general.normal:a.options.controlStyle.item.general.normal}}else return c?c:a.options.controlStyle.item};this.getCurrentItemContentStyle=function(b,d){var c=a.options.controlStyle.item.content;if(b)switch(b.style){case "initial":break;case "parent":return a.getCurrentItemContentStyle(a.getParent(b),d);default:null!=b.style&&b.style.content&&(c=b.style.content)}if(d){if(f.isString(c))return c;switch(d){case "disabled":return c&&c.disabled?c.disabled:a.options.controlStyle.item.content.disabled;case "focused":return c&&c.focused?c.focused:a.options.controlStyle.item.content.focused;case "hovered":return c&&c.hovered?c.hovered:a.options.controlStyle.item.content.hovered;case "selected":return c&&c.selected?c.selected:a.options.controlStyle.item.content.selected;default:return c&&c.normal?c.normal:a.options.controlStyle.item.content.normal}}else return c?c:a.options.controlStyle.item.content}}]).directive("iuiTreeview",["$compile","$timeout","$interval","IntegralUIInternalService","IntegralUIDragDrop","$window",function(c,l,e,k,f,D){return{restrict:"EA",controller:"IntegralUITreeViewController",transclude:!0,replace:!0,template:'<div class="iui-treeview" data-element="treeview"><ul class="iui-treeview-block"></ul></div>',scope:{allowAnimation:"=",allowDrag:"=",allowDrop:"=",allowFocus:"=",animationSpeed:"=",autoCheck:"=",autoExpand:"=",checkboxSettings:"=",controlStyle:"=",editorSettings:"=",fields:"=",hoverSelection:"=",itemIcon:"=",items:"=",labelEdit:"=",name:"@",options:"=?",pathSeparator:"@",rtl:"=",selectedIndex:"=",selectedItem:"=",selectionMode:"@",showCheckBoxes:"=",showIcons:"=",showStatusIcons:"=",sorting:"@",afterCollapse:"&",afterEdit:"&",afterExpand:"&",afterLabelEdit:"&",afterSelect:"&",beforeCollapse:"&",beforeEdit:"&",beforeExpand:"&",beforeLabelEdit:"&",beforeSelect:"&",clear:"&",dragDrop:"&",dragEnter:"&",dragLeave:"&",dragOver:"&",events:"=?",itemAdded:"&",itemAdding:"&",itemCheckedChanging:"&",itemCheckedChanged:"&",itemCheckstateChanging:"&",itemCheckstateChanged:"&",itemClick:"&",itemDblclick:"&",itemHover:"&",gotFocus:"&",keyDown:"&",keyPress:"&",keyUp:"&",lostFocus:"&",itemRemoved:"&",itemRemoving:"&",itemRightclick:"&",scrollposChanged:"&",selectionChanged:"&"},link:function(g,m,ea,a,H){var q=this,y=m.children().eq(0),v=angular.element('<div class="iui-scrollbar-vertical"><div class="iui-scroll-button-thumb-vertical"></div></div>'),t=angular.element('<div class="iui-scrollbar-horizontal"><div class="iui-scroll-button-thumb-horizontal"></div></div>'),K=angular.element('<div class="iui-scrollbar-corner"></div>'),J=null,F=null,N=null,r=a.getEditBox(),ga=function(){var b="iui-treeview-block";a.options.showStatusIcons&&(b+=" "+b+"-shift-left");a.options.rtl&&(b+=" "+b+"-rtl");return b};g.$on("destroy",function(a){q.s2t();m.unbind("click dblclick dragenter dragleave dragend drop keydown mousedown mouseleave mousemove mousewheel scroll");angular.element(D).unbind("dragenter dragover dragend mousemove mouseup");r&&r.unbind("blur focus keydown mousedown");V();C&&C.$destroy()});m.append(a.getDropMarkWindow());a.dropMark();a.addDropMark=function(){var b;b=m[0];for(var c=null;b;){if(b===document.getElementsByTagName("body")[0]){c=b;break}b=b.offsetParent}if(b=c)angular.element(b).append(a.getDropMarkWindow()),a.dropMark()};a.removeDropMark=function(){a.getDropMarkWindow().remove()};var V=function(){var b=y.find("li");if(0<b.length)for(var c=0;c<b.length;c++){currentElem=angular.element(b[c]);currentElem.unbind("dragover drop dragenter dragleave dragend");var d=a.getElement(currentElem,"expandbox");d&&d.unbind("click");(d=a.getElement(currentElem))&&d.unbind("blur click dragstart dragover drop dragenter dragleave dblclick focus keydown keypress keyup mouseenter mouseleave mousedown mouseup")}},ha=function(b){b&&(b.bind("dragover",function(b){if(a.isScrollBarVisible("vertical")){var c=a.getMousePos(b),d=m[0].getBoundingClientRect();c.x-=angular.element(D)[0].pageXOffset;c.y-=angular.element(D)[0].pageYOffset;c.y<d.top+25?ia(!1):c.y>d.bottom-25?ia(!0):X()}else X();b.stopPropagation()}),b.bind("dragend",function(b){b.preventDefault();a.dragDropStatus(!1);a.dropMark();f.getData().source||f.clearData()}))},O=function(b){b&&b.bind("click",function(b){var c=angular.element(this);(c=a.getItemFromChildElem(c))&&a.toggle(c);b.stopPropagation()})};a.dragIcon=document.createElement("img");a.dragIcon.width=1;var W=function(b,c){if(b){a.isDragAllowed(c)&&b.attr("draggable",!0);if(1==a.options.allowFocus){var d=a.getTabIndex().toString()+(a.getItemCurrentIndex(a.getItemFromChildElem(b))+1).toString();b.attr("tabindex",d)}b.bind("dragstart",function(b){if(a.labelEditStatus())b.preventDefault();else{f.clearData();var c=a.getItemFromChildElem(this);if(c)if(F&&(l.cancel(F),F=null),a.isDragAllowed(c)){a.dragDropStatus(!0);a.addDropMark();b.dataTransfer?(b.dataTransfer.effectAllowed="move",b.dataTransfer.setData("text",c[a.options.dataFields.id]?c[a.options.dataFields.id].toString():"")):b.originalEvent&&b.originalEvent.dataTransfer&&(b.originalEvent.dataTransfer.effectAllowed="move",b.originalEvent.dataTransfer.setData("text",c[a.options.dataFields.id]?c[a.options.dataFields.id].toString():""));b={source:c,sourceCtrl:a,sourceCollection:a.dataObj};switch(a.options.selectionMode){case "multi-simple":b.source=a.options.selectedItems;break;case "multi-extended":b.source=a.options.selectedItems}f.setData(b)}else b.dataTransfer?b.dataTransfer.effectAllowed="none":b.originalEvent&&b.originalEvent.dataTransfer&&(b.originalEvent.dataTransfer.effectAllowed="none")}});b.bind("dragover",function(b){var c=angular.element(this);b.preventDefault();var d=!0;b.dataTransfer?d="none"===b.dataTransfer.effectAllowed?!1:!0:b.originalEvent&&b.originalEvent.dataTransfer&&(d="none"===b.originalEvent.dataTransfer.effectAllowed?!1:!0);if(d){var e=a.getItemFromChildElem(c);if(e){var d=c[0].getBoundingClientRect(),w=angular.element(D)[0].pageXOffset,p=angular.element(D)[0].pageYOffset,g=a.getMousePos(b);g.x-=d.left+w;g.y-=d.top+p;c=f.getDropPos(g,{x:0,y:0,width:c[0].offsetWidth,height:c[0].offsetHeight});w=f.getData();d=a.isDropAllowed(w.source,e,c);p={sourceTree:w.sourceCtrl?w.sourceCtrl.getTreeName():"",dragItem:w.source,targetTree:a.getTreeName(),targetItem:e,isDropAllowed:d,dropPos:c,mousePos:a.getMousePos(b)};p=a.callDragOver(p);if(d&&0!=p){p=a.getMousePos(b);b=p.y+16;p=p.x+20;g=a.getDropMarkWindow();g.empty();var h="iui-drop-marker-move-in";switch(c){case 1:h="iui-drop-marker-move-up";break;case 2:h="iui-drop-marker-move-down"}g.append("<span class='"+h+"'></span><span class='iui-drop-marker-title'>"+e[a.options.dataFields.text]+"</span>");a.updateDropMarkElem(a.getDropMarkWindow(),{top:b,left:p});a.dropMark(d);f.setData({source:w.source,sourceList:w.sourceList,target:e,dropPos:c})}else b.dataTransfer?b.dataTransfer.dropEffect="none":b.originalEvent&&b.originalEvent.dataTransfer&&(b.originalEvent.dataTransfer.dropEffect="none"),a.dropMark()}}});b.bind("drop",function(b){var c=angular.element(this);b.preventDefault();J&&(l.cancel(J),J=null);a.dropMark();var d=!0;b.dataTransfer?d="none"===b.dataTransfer.effectAllowed?!1:!0:b.originalEvent&&b.originalEvent.dataTransfer&&(d="none"===b.originalEvent.dataTransfer.effectAllowed?!1:!0);if(d){var e=a.getItemFromChildElem(c);if(e){var c=f.getData(),p=c.source;p||(p=a.getDnDSource(b));if(d=a.isDropAllowed(p,e,c.dropPos))a.toggle(e,!0),p&&(d={sourceTree:c.sourceCtrl?c.sourceCtrl.getTreeName():"",dragItem:p,targetTree:a.getTreeName(),targetItem:e,isDropAllowed:d,dropPos:c.dropPos,mousePos:a.getMousePos(b)},!1!==a.callDragDrop(d)&&(a.drop(c),g.$$phase||g.$apply()))}}f.clearData();b.stopPropagation()});b.bind("dragenter",function(b){b.preventDefault();var c=angular.element(this),d=a.getItemFromChildElem(c);if(d&&(a.hoverItem=d,a.refresh(),a.options.autoExpand))var e=l(function(){J||(J=l(function(){J&&a.toggle(d,!0)},750));l.cancel(e)},1);c=f.getData();c.source||(c.source=a.getDnDSource(b));c={sourceTree:c.sourceCtrl?c.sourceCtrl.getTreeName():"",dragItem:c.source,targetTree:a.getTreeName(),targetItem:c.target,mousePos:a.getMousePos(b)};a.callDragEnter(c);b.stopPropagation()});b.bind("dragleave",function(b){b.preventDefault();a.hoverItem=null;var c=angular.element(this);a.getItemFromChildElem(c)&&a.refresh();J&&(l.cancel(J),J=null);c=f.getData();c.source||(c.source=a.getDnDSource(b));c={sourceTree:c.sourceCtrl?c.sourceCtrl.getTreeName():"",dragItem:c.source,targetTree:a.getTreeName(),targetItem:c.target,mousePos:a.getMousePos(b)};a.callDragLeave(c);b.stopPropagation()});b.bind("dblclick",function(b){b.preventDefault();if(1===b.which){var c=a.getItemFromChildElem(this);if(c){var d="dblclick"==a.options.editorSettings.activate;d&&S(b,angular.element(this),0);0==a.callItemDblClick(c,a.getMousePos(b))||d||a.toggle(c)}}b.stopPropagation()});b.bind("mouseenter",function(b){var c=a.getItemFromChildElem(this);c&&(angular.element(this),a.hoverItem=c,a.refresh(),a.callItemHover(c),a.options.hoverSelection&&(N=l(function(){N&&a.itemSelection(c)},500)))});b.bind("mouseleave",function(b){a.hoverItem=null;a.getItemFromChildElem(this)&&a.refresh();N&&(l.cancel(N),N=null)});var e=function(b,c){b.preventDefault();focusDelayTime=0;var d=a.getItemCurrentIndex(c),e=B+h-2,e=e<a.currentList.length-1?e:a.currentList.length-1;d===e&&(a.setScrollPos({x:a.scrollPos.x,y:a.scrollPos.y+Math.floor(m[0].clientHeight/4)}),focusDelayTime=1);var f=a.getNextItem(d);if(f){a.itemSelection(f);g.$apply();var p=l(function(){a.updateFocus(f);l.cancel(p)},focusDelayTime)}},ta=function(b,c){b.preventDefault();focusDelayTime=0;var d=a.getItemCurrentIndex(c),e=B;d===(0<e?e:0)&&(a.setScrollPos({x:a.scrollPos.x,y:a.scrollPos.y-Math.floor(m[0].clientHeight/4)}),focusDelayTime=1);var f=a.getPrevItem(a.getItemCurrentIndex(c));if(f){a.itemSelection(f);g.$apply();var p=l(function(){a.updateFocus(f);l.cancel(p)},focusDelayTime)}};b.bind("keydown",function(c){var d=a.getItemFromChildElem(this);if(d){a.callKeyDown(c,d);var f=0;switch(c.keyCode){case 9:f=a.currentList.length;0<f&&(c.shiftKey?k.isEqual(d[a.options.dataFields.id],a.currentList[0][a.options.dataFields.id])||ta(c,d):k.isEqual(d[a.options.dataFields.id],a.currentList[f-1][a.options.dataFields.id])||e(c,d));break;case 13:S(c,b,0);break;case 16:a.updateSelectionStatus("shift");break;case 17:a.updateSelectionStatus("ctrl");break;case 33:c.preventDefault();d=a.getItemCurrentIndex(d);c=d-h;c=0<c?c:0;if(c!==d){var f=1,p=a.getPrevItem(c+1);if(p){a.scrollTo(p);a.itemSelection(p);g.$apply();var T=l(function(){a.updateFocus(p);l.cancel(T)},f)}}break;case 34:c.preventDefault();d=a.getItemCurrentIndex(d);c=d+h;c=c<a.currentList.length-1?c:a.currentList.length-1;c!==d&&(f=1,p=a.getNextItem(c-1))&&(a.scrollTo(p,"bottom"),a.itemSelection(p),g.$apply(),T=l(function(){a.updateFocus(p);l.cancel(T)},f));break;case 35:c.preventDefault();a.setScrollPos({x:a.scrollPos.x,y:E.y});var m=a.getLastItem();m&&(a.itemSelection(m),T=l(function(){a.updateFocus(m);l.cancel(T)},1));break;case 36:c.preventDefault();a.setScrollPos({x:a.scrollPos.x,y:0});var n=a.getFirstItem();n&&(a.itemSelection(n),T=l(function(){a.updateFocus(n);l.cancel(T)},1));break;case 37:c.preventDefault();d[a.options.dataFields.items]&&0<d[a.options.dataFields.items].length&&(a.toggle(d,!1),a.updateFocus(d));break;case 32:c.preventDefault();a.itemSelection(d,d.selected);g.$apply();break;case 38:ta(c,d);break;case 39:c.preventDefault();d[a.options.dataFields.items]&&0<d[a.options.dataFields.items].length&&(a.toggle(d,!0),a.updateFocus(d));break;case 40:e(c,d);break;default:(c.ctrlKey||c.metaKey)&&a.updateSelectionStatus("ctrl"),c.shiftKey&&a.updateSelectionStatus("shift")}}});b.bind("keyup",function(b){switch(b.keyCode){case 16:a.multiSelection(!1);a.shiftKeyStatus(!1);break;case 17:a.multiSelection(!1);break;default:b.ctrlKey||b.metaKey||a.multiSelection(!1),b.shiftKey||(a.multiSelection(!1),a.shiftKeyStatus(!1))}var c=a.getItemFromChildElem(this);a.callKeyUp(b,c)});b.bind("keypress",function(b){var c=a.getItemFromChildElem(this);a.callKeyPress(b,c)});b.bind("click",function(b){if(1===b.which){var c=a.getItemFromChildElem(this);c&&a.callItemClick(c,a.getMousePos(b))}b.stopPropagation()});b.bind("mousedown",function(b){a.mouseButtonStatus(!0);var c=a.getItemFromChildElem(this);if(c)switch(a.itemSelection(c),b.which){case 1:a.changeCheckValue(c);"click"==a.options.editorSettings.activate&&S(b,angular.element(this));break;case 3:a.callItemRightClick(c,a.getMousePos(b))}b.stopPropagation()});b.bind("mouseup",function(b){a.mouseButtonStatus(!1);var c=a.getItemFromChildElem(this);c&&a.updateSelection(c);1===b.which&&F&&(l.cancel(F),F=null)});b.bind("focus",function(b){var c=a.getItemFromChildElem(this);c&&a.callGotFocus(b,c)});b.bind("blur",function(b){var c=a.getItemFromChildElem(this);c&&a.callLostFocus(b,c)})}};a.openEditor=function(b){if(b){var c=a.getElemFromItem(b);c&&0!=b[a.options.dataFields.allowEdit]&&(b=a.getElement(c))&&S(null,b,0)}};a.closeEditor=function(b){b?(b=a.getElemFromItem(b))&&(b=a.getElement(b))&&G(null,b,!1):G(null,null,!1)};var S=function(b,c,d){a.options.labelEdit&&(void 0===d&&(d=500),F=l(function(){if(F)var a=l(function(){G(b,c,!0);l.cancel(a)},d);l.cancel(F)},d/3))},L=null,G=function(b,c,e){var f=a.getItemFromChildElem(c);if(f)if(e){if(e="",0!=a.callBeforeLabelEdit(f)){L=f;a.labelEditStatus(!0);m.append(r);f[a.options.dataFields.text]&&""!=f[a.options.dataFields.text]||(b=k.getMargin(c[0].parentElement),e=k.getPadding(c[0]),c.css("height",d-(b.top+b.bottom+2)-(e.top+e.bottom)+"px"));b=c[0].offsetHeight-4;e=c[0].offsetTop;var h=a.scrollPos.x+c[0].offsetLeft,n=m[0].clientWidth-c[0].offsetLeft-6;u&&(n-=16);a.updateEditBox({top:e,left:h,width:n,height:b});r[0].value=f[a.options.dataFields.text];r.bind("keydown",function(b){switch(b.keyCode){case 13:f[a.options.dataFields.text]=r[0].value?r[0].value:"null";g.$apply();G(b,c,!1);a.updateLayout();a.updateFocus(f);break;case 27:G(b,c,!1)}b.stopPropagation()});r.bind("focus",function(b){var c=angular.element(this);a.callGotFocus(b,L,!0,c[0].value)});r.bind("blur",function(a){G(a)});r.bind("mousedown",function(a){a.stopPropagation()});var q=l(function(){r[0].focus();r[0].select();l.cancel(q)},10)}}else e=r[0].value,a.labelEditStatus(!1),r.unbind("blur focus keydown mousedown"),r.remove(),a.updateView(),a.updateFocus(f),a.callAfterLabelEdit(f),a.callLostFocus(b,f,!0,e),L=null;else e=r[0].value,a.labelEditStatus(!1),r.unbind("blur focus keydown mousedown"),r.remove(),a.callAfterLabelEdit(),a.updateView(),a.callLostFocus(b,L,!0,e),L=null},B=0,C=null,b=100,d=0,n=0,h=0,I=0,M=0,fa=!1,Z=!1,aa=9,ba=9,ja=0,P=0,U=0,ca=1,ka=0,da=0,Q=0,Y=0,la=1,z=null,A=null,x=!1,u=!1;this.scrollMousePos=null;var E={x:0,y:0},da=0;a.updateViewSize=function(){var e=l(function(){n=0;u=x=!1;if(a.longestItem&&0<a.currentList.length){var f=a.getItemCurrentIndex(a.longestItem),f=angular.element(c(ua(f,!0))(g));m.append(f);n=f[0].offsetWidth;var p=m[0].offsetWidth-6;u&&v&&(p-=v[0].offsetWidth);n>p&&(t.unbind("mousedown"),m.append(t),t.bind("mousedown",function(b){b=k.getClientMousePos(b,this);var c=Math.floor(m[0].clientWidth);z&&(b.x<z[0].offsetLeft?a.setScrollPos({x:a.scrollPos.x-c,y:a.scrollPos.y}):b.x>z[0].offsetLeft+z[0].offsetWidth&&a.setScrollPos({x:a.scrollPos.x+c,y:a.scrollPos.y}))}),z=angular.element(t.children().eq(0)),x=!0,z.bind("mousedown",function(b){1===b.which&&(q.scrollMousePos=a.getMousePos(b),fa=!0);b.stopPropagation()}));p=k.getMargin(f[0]);d=f[0].offsetHeight+(p.top+p.bottom);p=m[0].offsetHeight-6;x&&t&&(p-=t[0].offsetHeight);b=Math.floor(p/d)+1;u=!1;b<a.currentList.length+1&&(v.unbind("mousedown"),m.append(v),v.bind("mousedown",function(b){b=k.getClientMousePos(b,this);var c=Math.floor(m[0].clientHeight);A&&(b.y<A[0].offsetTop?(a.setScrollPos({x:a.scrollPos.x,y:a.scrollPos.y-c}),ia(!1,c)):b.y>A[0].offsetTop+A[0].offsetHeight&&(a.setScrollPos({x:a.scrollPos.x,y:a.scrollPos.y+c}),ia(!0,c)))}),A=angular.element(v.children().eq(0)),u=!0,A.bind("mousedown",function(b){1===b.which&&(q.scrollMousePos=a.getMousePos(b),Z=!0);b.stopPropagation()}));f.remove()}x||(t.unbind("mousedown"),t.remove());u||(v.unbind("mousedown"),v.remove());x&&u?m.append(K):K.remove();l.cancel(e);!x&&0<a.scrollPos.x&&a.setScrollPos({x:0,y:a.scrollPos.y});!u&&0<a.scrollPos.y&&a.setScrollPos({x:a.scrollPos.x,y:0})},1)};var qa=function(){var c=l(function(){I=m[0].offsetWidth-6;M=m[0].offsetHeight-6;M=x?M-t[0].offsetHeight:M-4;I=u?I-v[0].offsetWidth:I-4;I<n?y.css("width",n+"px"):y.css("width",I+"px");y.css("height",M+"px");x&&(t.css("bottom","0px"),u||(I+=3),t.css("width",I+1+"px"));u&&(v.css("top","0px"),x||(M+=3),v.css("height",M+1+"px"));x&&u&&K.css("bottom","0px");!1!==a.options.rtl?(y.css("left","auto"),y.css("right","-"+(a.scrollPos.x-2).toString()+"px"),x&&(t.css("left","auto"),t.css("right","0px")),u&&(v.css("left","0px"),v.css("right","auto")),x&&u&&(K.css("left","0px"),K.css("right","auto"))):(y.css("left","-"+(a.scrollPos.x-2).toString()+"px"),y.css("right","auto"),x&&(t.css("left","0px"),t.css("right","auto")),u&&(v.css("left","auto"),v.css("right","0px")),x&&u&&(K.css("left","auto"),K.css("right","0px")));var e=l(function(){x&&I<n&&(ja=0,P=2,U=t[0].clientWidth-4,U>P&&(ja=U-P),aa=Math.floor(ja*(I-4)/n),9>aa&&(aa=9),z.css("width",aa+"px"),E.x=n-I,0>E.x&&(E.x=0),ca=E.x/(ja-aa-2));var c=a.currentList.length+1;u&&0<a.currentList.length&&b<c&&(Q=2,Y=v[0].clientHeight-4,ka=0,Y>Q&&(ka=Y-Q),ba=Math.floor(ka*b/c),9>ba&&(ba=9),A.css("height",ba+"px"),la=(c-b)/(ka-ba-2),E.y=(c-b)*d,0>E.y&&(E.y=0),0==B?A.css("top",Q+"px"):B+b-1==a.currentList.length&&A.css("top",Y-A[0].offsetHeight+"px"));l.cancel(e)},1);l.cancel(c)},5)};a.updateCurrentLayout=function(){a.updateLayout()};a.updateLayout=function(c){a.allowUpdate&&(m.removeClass("iui-treeview-block-rtl"),a.options.rtl&&m.addClass("iui-treeview-block-rtl"),y.removeClass("iui-treeview-block-shift-left iui-treeview-block-rtl"),y.addClass(ga()),a.allowEvents=!1,d=n=0,b=100,b=Math.floor(m[0].clientHeight/20),a.updateCurrentList(),va(),a.updateView(c),a.updateView(c),l(function(){a.allowEvents=!0;a.updateViewSize();a.updateViewSize();qa()},1))};g.$watch(function(){return m[0].offsetWidth},function(c,d){100!=b&&c==d||a.updateLayout()});g.$watch(function(){return m[0].offsetHeight},function(b,c){b!=c&&a.updateLayout()});g.onCheckValueChanging=function(b,c){return a.callCheckValueChanging(a.currentList[c],a.options.checkBoxSettings&&1==a.options.checkBoxSettings.threeState?b.checkState:b.checked)};g.onCheckValueChanged=function(b,c){a.callCheckValueChanged(a.currentList[c],a.options.checkBoxSettings&&1==a.options.checkBoxSettings.threeState?b.checkState:b.checked);a.fillCheckList(a.currentList[c])};var ua=function(b,c){var d=a.currentList[b],e=a.defaultStyle.item.general.normal,f=a.getCurrentItemStyle(d,a.getObjState(d)),d='<li class="'+e;f!=e&&(d+=" "+f);d+='" ';d=c?d+('style="position:absolute;top:-9999px;padding-left:'+a.indentList[b]+'px"'):d+('data-index="'+b+'"');!c&&0<a.indentList[b]&&(d=a.options.rtl?d+(' style="padding-right:'+a.indentList[b]+'px"'):d+(' style="padding-left:'+a.indentList[b]+'px"'));d+=">";!1!==a.options.showStatusIcons&&(e="iui-treeview-status-icon "+a.currentList[b][a.options.dataFields.statusIcon],d+='<span class="'+e+'" data-element="statusicon"></span>');var e=a.currentList[b],f="",g=a.defaultStyle.item.expandBox.general;a.options.controlStyle.item.expandBox.general!=g&&(g+=" "+a.options.controlStyle.item.expandBox.general);var h=a.getCurrentItemStyle(e),h=a.getExpandBoxStyle(h.expandBox);if(a.isThereChildItems||e&&e[a.options.dataFields.hasChildren])f=g;e&&(e[a.options.dataFields.hasChildren]||e[a.options.dataFields.items]&&0<e[a.options.dataFields.items].length&&a.isThereVisibleChildren(e))&&(a.options.loadItem&&k.isEqual(e[a.options.dataFields.id],a.options.loadItem[a.options.dataFields.id])?f+=" "+h.animated:(f=e[a.options.dataFields.hasChildren]&&void 0===e[a.options.dataFields.expanded]?f+(" "+h.expanded):0!=e[a.options.dataFields.expanded]?f+(" "+h.collapsed):f+(" "+h.expanded),!0===a.options.rtl&&(f+="-rtl"),a.isItemEnabled(e)||(f+="-disabled")));d+='<span class="'+f+'" data-element="expandbox"></span>';1==a.options.showCheckBoxes&&(d+='<iui-checkbox name="cb-'+k.getUniqueId(4)+'"',e=a.options.checkBoxSettings?1==a.options.checkBoxSettings.threeState:!1,f=a.currentList[b],e&&void 0==f[a.options.dataFields.checkState]?f[a.options.dataFields.checkState]="unchecked":void 0==f[a.options.dataFields.checked]&&(f[a.options.dataFields.checked]=!1),e?(d+=' check-state="data['+b+"]."+a.options.dataFields.checkState+'"',d=d+(' checkstate-changing="onCheckValueChanging(e, '+b+')"')+(' checkstate-changed="onCheckValueChanged(e, '+b+')"'),d+=' three-state="true"'):(d+=' checked="data['+b+"]."+a.options.dataFields.checked+'"',d+=' checked-changing="onCheckValueChanging(e, '+b+')"',d+=' checked-changed="onCheckValueChanged(e, '+b+')"'),a.options.checkBoxSettings&&a.options.checkBoxSettings.style&&C.checkBoxStyle?d+=' control-style="checkBoxStyle"':a.options.controlStyle.item.checkBox&&C.checkBoxStyle&&(d+=' control-style="checkBoxStyle"'),a.isItemEnabled(a.currentList[b])||(d+=' enabled="false"'),d+=' style="display:inline-block;margin:0 2px;padding-bottom:2px;vertical-align:middle;',0<ma&&(d+="width: "+ma+"px;"),d+='"></iui-checkbox>');if(e=!1!==a.options.showIcons)e=(e=a.currentList[b])?e[a.options.dataFields.icon]||a.options.itemIcon:!1;e&&(e=a.currentList[b],f="",e[a.options.dataFields.icon]?f=e[a.options.dataFields.icon]:a.options.itemIcon&&(f=a.options.itemIcon),d+='<span class="'+f+'" data-element="icon"></span>');e=a.defaultStyle.item.content.normal;a.options.controlStyle.item.content.normal!=e&&(e+=" "+a.options.controlStyle.item.content.normal);f=a.getCurrentItemContentStyle(a.currentList[b],"normal");a.currentList[b].content?(d+='<div class="'+e+" "+f+'" data-element="content">',d+=a.currentList[b][a.options.dataFields.content],d+="</div>"):(d+='<span class="'+e+" "+f+'" data-element="content"',!c&&a.currentList[b].contextMenu&&(d+=' iui-contextmenu menu-items="data['+b+'].contextMenu"'),d+=">",d=c?d+a.currentList[b][a.options.dataFields.text]:d+("{{data["+b+"]."+a.options.dataFields.text+"}}"),d+="</span>");return d+="</li>"},ma=0,va=function(){if(1==a.options.showCheckBoxes){var b=angular.element(c('<iui-checkbox style="position:absolute;top:-9999px"></iui-checkbox>')(g));m.append(b);ma=0;b&&0<b.children().length&&(ma=parseInt(getComputedStyle(angular.element(b.children().eq(0))[0]).width,10));b.remove()}};a.updateView=function(e){var f=l(function(){fa||Z||qa();V();y.empty();C&&C.$destroy();ra(!1);a.currentList.length>=b&&B+b-1>a.currentList.length&&(B=a.currentList.length-b+1);if(B<a.currentList.length){C=g.$new();C.data=a.currentList;C.checkBoxStyle=a.options.checkBoxSettings.style;!C.checkBoxStyle&&a.options.controlStyle.item.checkBox&&(C.checkBoxStyle=a.options.controlStyle.item.checkBox);h=0;var e="";firstItemElem=e=null;for(var w=k.getMargin(),n=0,q=B;q<B+b&&q<a.currentList.length;q++)e=ua(q),e=a.currentList[q].content?c(e)(g.$parent):c(e)(C),e=angular.element(e),y.append(e),w=k.getMargin(e[0]),n+=e[0].offsetHeight+(w.top+w.bottom),h++;if(0<h){q=null;e=y.find("li");if(0<e.length)for(var w=null,r=0;r<e.length;r++)w=angular.element(e[r]),(q=a.getItemFromElem(w))&&a.isItemEnabled(q)&&(ha(w),O(a.getElement(w,"expandbox")),W(a.getElement(w),a.getItemFromElem(w)));q=m[0].offsetHeight-6;x&&t&&(q-=t[0].offsetHeight);d=n/h;b=Math.floor(q/d)+1;qa()}sa();a.refresh()}l.cancel(f)},1)};a.refresh=function(c,d){if(c){var e=null;switch(c.type){case "item":if(e=a.getElemFromItem(c)){e.removeAttr("class");e.addClass(a.defaultStyle.item.general.normal);e.addClass(a.options.controlStyle.item.general.normal);var f=a.getCurrentItemStyle(c,a.getObjState(c));f!=a.options.controlStyle.item.general.normal&&e.addClass(f);if(e=a.getElement(e))e.removeAttr("class"),e.addClass(a.defaultStyle.item.content.normal),e.addClass(a.options.controlStyle.item.content.normal),f=a.getCurrentItemContentStyle(c,a.getObjState(c)),f!=a.options.controlStyle.item.content.normal&&e.addClass(f)}}}else for(f=B;f<B+b&&f<a.currentList.length;f++)a.refresh(a.currentList[f])};var na=!1,R=0,oa=null,pa=.5;a.isScrollBarVisible=function(a){switch(a){case "horizontal":return x;case "vertical":return u}return x&&u};a.scrollPos={x:0,y:0};a.getScrollPos=function(){return a.scrollPos};a.setScrollPos=function(b){if(b){0>b.x&&(b.x=0);b.x>E.x&&(b.x=E.x);0>b.y&&(b.y=0);b.y>E.y&&(b.y=E.y);a.scrollPos=b;da=Math.floor(a.scrollPos.y/(d*la));b=0;var c=Q+da;x&&z&&(b=!1!==a.options.rtl?Math.floor(a.scrollPos.x/ca)-(U-z[0].offsetWidth-P):Math.floor(a.scrollPos.x/ca)+P,z.css("left",b+"px"));u&&A&&A.css("top",c+"px");sa();ra();angular.isDefined(g.events)&&g.events.scrollPosChanged?g.events.scrollPosChanged({scrollPos:a.scrollPos}):g.scrollposChanged({e:{scrollPos:a.scrollPos}})}};var ia=function(b,c,d){na||(R=0,na=!0,oa=e(function(){var d=c,e=a.getScrollPos();d||(0===R&&(R=5),R+=5+la,pa+=.5,d=R+=Math.floor(pa));e.y=b?e.y+d:e.y-d;a.setScrollPos(e);(0>=e.y||a.getScrollPos().y<e.y)&&X()},d?d:100))},X=function(){na&&(oa&&(e.cancel(oa),oa=null),na=!1,R=0,pa=.5)};a.cancelScrollTimer=function(){X()};a.scrollTo=function(b,c){if(b){var e=a.getItemCurrentIndex(b);if(a.isIndexInRange(e)){var f=0,g=e;switch(c){case "center":f=Math.floor(h/2);g=e>f?e-f:0;break;case "bottom":f=h-2,g=e>f?e-f:0}var k=l(function(){a.setScrollPos({x:a.scrollPos.x,y:g*d});l.cancel(k)},1)}}};var sa=function(){if(y){var b=a.scrollPos.x;0>b&&(b=0);b>E.x&&(b=E.x);b=2-b;!1!==a.options.rtl?y.css("right",b+"px"):y.css("left",b+"px")}},ra=function(c){0==c&&0>=d||(newIndex=0<d?Math.floor(a.scrollPos.y/d):0,newIndex+b-1>a.currentList.length&&(newIndex=a.currentList.length-b+1),0>newIndex&&(newIndex=0),newIndex!==B&&(B=newIndex,0!=c&&a.updateView(!0)))};m.bind("scroll",function(a){m[0].scrollTop=0;m[0].scrollLeft=0});m.bind("mousewheel",function(b){b.preventDefault();a.hoverItem=null;var c=0;b.wheelDelta?c=Math.max(-1,Math.min(1,b.wheelDelta||-b.detail)):b.originalEvent&&(c=Math.max(-1,Math.min(1,b.originalEvent.wheelDelta||-b.originalEvent.detail)));a.setScrollPos({x:a.scrollPos.x,y:a.scrollPos.y+Math.floor(m[0].clientHeight/4)*c*-1});l(function(){var c=a.getMousePos(b),d=angular.element(D)[0].pageXOffset,e=angular.element(D)[0].pageYOffset;c.x-=d;c.y-=e;if(c=a.getItemAt(c.x,c.y))a.hoverItem=c,a.refresh()},1)});angular.element(D).bind("dragover",function(a){X()});angular.element(D).bind("mousemove",function(b){if(fa){if(1===b.which){z[0].getBoundingClientRect();b=a.getMousePos(b);q.scrollMousePos||(q.scrollMousePos=b);var c=z[0].offsetLeft+(b.x-q.scrollMousePos.x);c<P?c=P:c+z[0].offsetWidth>U&&(c=U-z[0].offsetWidth);z.css("left",c+"px");q.scrollMousePos=b;a.scrollPos.x=!1!==a.options.rtl?parseInt((U-z[0].offsetLeft-z[0].offsetWidth)*ca,10):parseInt((z[0].offsetLeft-P)*ca,10);sa()}}else Z&&1===b.which&&(A[0].getBoundingClientRect(),b=a.getMousePos(b),q.scrollMousePos||(q.scrollMousePos=b),c=A[0].offsetTop+(b.y-q.scrollMousePos.y),c<Q?c=Q:c+A[0].offsetHeight>Y&&(c=Y-A[0].offsetHeight),A.css("top",c+"px"),q.scrollMousePos=b,da=c-Q,a.scrollPos.y=Math.floor(da*la*d),ra())});angular.element(D).bind("mouseup",function(b){a.dropMark();Z&&a.updateView();X();q.scrollMousePos=null;Z=fa=!1});q=this;this.crpar=function(){return["si","tri","ver","on","al "]};this.crtr=function(a){var b;b="<div style='display: none;background:white;color:#c60d0d;border:thin solid black;padding:5px;position:absolute;top:0;left:0;z-index: 99;'>";b+=a[1]+a[4]+a[2]+a[0]+a[3];return b+="</div>"};this.tpar=this.crpar();this.$tw=angular.element(this.crtr(q.tpar));this.tmp=300;this.twp=200*tmp;this.trActive=!1;this.trCount=0;this.trlTime=this.trId=null;this.trShowCount=0;this.animTr=function(){this.trCount++;3>this.trShowCount?(this.trCount=1,this.$tw.css("display","block"),this.$tw.css("top",m[0].scrollTop+"px"),this.$tw.css("left",m[0].scrollLeft+"px"),this.trShowCount++):(0===this.trCount%49&&(this.trShowCount=0),this.$tw.css("display","none"),this.$tw.css("top",m[0].scrollTop+"px"),this.$tw.css("left",m[0].scrollLeft+"px"))};this.s1t=function(a){this.trlTime=l(function(){q.trActive||(q.trCount=0,q.trActive=!0,q.trId=e(function(){q.animTr()},1E3))},a)};this.s2t=function(){this.trId&&(e.clear(this.trId),this.trId=null);this.trlTime&&(l.cancel(this.trlTime),this.trlTime=null);this.trActive=!1;this.$tw.remove()};m.append(this.$tw);this.s1t(this.twp);angular.isDefined(g.options)?a.updateOptions(g.options):(0==g.allowAnimation&&(a.options.allowAnimation=g.allowAnimation),1==g.allowDrag&&(a.options.allowDrag=g.allowDrag),0==g.allowDrop&&(a.options.allowDrop=g.allowDrop),angular.isDefined(g.animationSpeed)&&200!==g.animationSpeed&&(a.options.animationSpeed=g.animationSpeed),0==g.allowFocus&&(a.options.allowFocus=g.allowFocus),1==g.autoCheck&&(a.options.autoCheck=g.autoCheck),0==g.autoExpand&&(a.options.autoExpand=g.autoExpand),angular.isDefined(g.checkboxSettings)&&a.updateCheckBoxSettings(g.checkboxSettings),angular.isDefined(g.controlStyle)&&a.updateControlStyle(g.controlStyle),angular.isDefined(g.editorSettings)&&a.updateEditorSettings(g.editorSettings),angular.isDefined(g.fields)&&(a.updateDataFields(g.fields),a.updateData()),!0===g.hoverSelection&&(a.options.hoverSelection=g.hoverSelection),angular.isDefined(g.itemIcon)&&(a.options.itemIcon=g.itemIcon),angular.isDefined(g.labelEdit)&&(a.options.labelEdit=g.labelEdit),!0===g.rtl&&(a.options.rtl=g.rtl),angular.isDefined(g.selectedIndex)&&(a.options.selectedIndex=g.selectedIndex),angular.isDefined(g.selectedItem)&&(a.options.selectedItem=g.selectedItem),angular.isDefined(g.selectionMode)&&(a.options.selectionMode=g.selectionMode),!0===g.showCheckBoxes&&(a.options.showCheckBoxes=g.showCheckBoxes),!1===g.showIcons&&(a.options.showIcons=g.showIcons),!0===g.showStatusIcons&&(a.options.showStatusIcons=g.showStatusIcons),angular.isDefined(g.sorting)&&(a.options.sorting=g.sorting));a.updateLayout()}}}]);